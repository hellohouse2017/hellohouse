<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç·šä¸Šç°½ç½²ä½å®¿å¥‘ç´„ | ä½ å¥½å“‡å¯“æ‰€</title>
    <meta name="robots" content="noindex, nofollow"> 

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* =========================================
           âœ¨ Premium Design System âœ¨
           ========================================= */
        :root {
            --c-dark: #2C3E50;       
            --c-gold: #BFA15F;       
            --c-gold-light: #F9F5EB; 
            --c-red: #A94442;        
            --c-gray: #7F8C8D;       
            --c-white: #FFFFFF;
            --font-serif: 'Noto Serif TC', serif; 
            --font-sans: 'Noto Sans TC', sans-serif; 
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.06);
        }

        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: var(--font-sans);
            background-color: #F5F5F5;
            color: var(--c-dark);
            line-height: 1.7;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            overscroll-behavior: none; /* é˜²æ­¢ç°½åæ™‚æ‹‰å‹•é é¢ */
        }

        .navbar { background: var(--c-dark); height: 60px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; width: 100%; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-logo { color: var(--c-gold); font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-decoration: none; }

        .header-section { margin-top: 60px; padding: 40px 20px; text-align: center; background: var(--c-dark); color: white; }
        .header-section h1 { margin: 0; font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 3px; font-weight: 500; }
        .header-section p { margin: 5px 0 0; font-size: 0.8rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 2px; }

        .container { width: 95%; max-width: 800px; margin: -30px auto 40px; position: relative; z-index: 10; }

        #capture-area {
            background-color: var(--c-white);
            padding: 50px;
            border-radius: 4px;
            box-shadow: var(--shadow-card);
            border-top: 6px solid var(--c-gold);
            position: relative;
        }
        #capture-area::before {
            content: "OFFICIAL CONTRACT";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem; font-weight: bold; color: rgba(0,0,0,0.03); pointer-events: none; white-space: nowrap; font-family: sans-serif;
        }

        .contract-header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #EEE; padding-bottom: 20px; }
        .contract-header h2 { margin: 0; font-family: var(--font-serif); color: var(--c-dark); font-size: 1.6rem; letter-spacing: 1px; }
        .contract-header span { display: block; margin-top: 5px; color: var(--c-gray); font-size: 0.8rem; letter-spacing: 1px; }

        /* â˜…â˜…â˜… æ’ç‰ˆä¿®æ­£ï¼šé›»è…¦ç‰ˆ Grid â˜…â˜…â˜… */
        .form-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* é›»è…¦ç‰ˆé›™æ¬„ */
            gap: 20px; 
            margin-bottom: 20px; 
        }
        
        .form-group { margin-bottom: 5px; }
        
        /* å¼·åˆ¶ä½”æ»¿æ•´è¡Œçš„é¡åˆ¥ */
        .col-full { grid-column: span 2; } 

        .form-label { display: block; font-size: 0.85rem; color: var(--c-gray); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { 
            width: 100%; padding: 12px; font-size: 1rem; color: var(--c-dark); font-family: var(--font-serif);
            border: 1px solid #DDD; border-radius: 4px; background: #FAFAFA; transition: 0.3s; 
        }
        .form-input:focus { outline: none; border-color: var(--c-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1); }
        .form-input.readonly { background: #F9F5EB; border-color: #E0D6C3; color: #8A7A5B; font-weight: bold; cursor: default; }

        /* æŒ‰éˆ•å¼é¤¨åˆ¥é¸æ“‡å™¨ */
        .house-selector { display: flex; gap: 15px; }
        .house-btn {
            flex: 1; padding: 12px; border: 1px solid #DDD; border-radius: 6px;
            background: #FAFAFA; cursor: pointer; transition: 0.3s;
            text-align: center; position: relative;
        }
        .house-btn h4 { margin: 0; font-size: 1rem; color: var(--c-dark); font-weight: bold; }
        .house-btn span { font-size: 0.8rem; color: #999; }
        .house-btn:hover { background: #F0F0F0; }
        .house-btn.active { 
            border: 2px solid var(--c-gold); background: var(--c-gold-light); 
            box-shadow: 0 4px 10px rgba(191, 161, 95, 0.2);
        }
        .house-btn.active h4 { color: #A68550; }
        .house-btn.active::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: -10px; right: -5px; 
            background: var(--c-gold); color: white; width: 24px; height: 24px;
            border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
        }

        .section-title { 
            font-family: var(--font-serif); font-size: 1.2rem; color: var(--c-dark); 
            margin: 40px 0 20px; padding-left: 15px; border-left: 4px solid var(--c-gold); 
            display: flex; align-items: center; 
        }
        
        .contract-option-box {
            border: 2px solid var(--c-gold); background-color: var(--c-gold-light);
            padding: 20px; border-radius: 6px; position: relative; margin-bottom: 30px;
        }
        .contract-option-box.disabled { border: 1px dashed #DDD; background: #FAFAFA; opacity: 0.7; margin-bottom: 20px; }
        .option-badge {
            position: absolute; top: -12px; left: 15px; background: var(--c-gold); color: white;
            font-size: 0.75rem; padding: 2px 12px; border-radius: 20px; font-weight: bold; letter-spacing: 1px;
        }
        .contract-option-box.disabled .option-badge { background: #CCC; }
        
        .legal-text { font-size: 0.9rem; color: #555; text-align: justify; margin-top: 10px; }
        .legal-text p { margin: 5px 0; text-indent: -1.5em; padding-left: 1.5em; }

        .rules-list { list-style: none; padding: 0; margin: 0; }
        .rule-item { 
            display: flex; align-items: flex-start; margin-bottom: 15px; 
            padding-bottom: 15px; border-bottom: 1px dashed #EEE; 
        }
        .rule-item:last-child { border-bottom: none; }
        .rule-icon { 
            width: 35px; height: 35px; background: #F2F2F2; color: var(--c-dark); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            margin-right: 15px; flex-shrink: 0; font-size: 0.9rem;
        }
        .rule-item.warning .rule-icon { background: #FDEDEC; color: var(--c-red); }
        .rule-content h4 { margin: 0 0 5px; font-size: 1rem; font-weight: bold; color: var(--c-dark); }
        .rule-content p { margin: 0; font-size: 0.9rem; color: #666; }
        .rule-content ul { padding-left: 20px; margin: 5px 0; }
        .highlight { color: var(--c-red); font-weight: bold; background: #FDEDEC; padding: 0 4px; border-radius: 2px;}

        /* ç°½åå€ */
        .signature-section { margin-top: 50px; page-break-inside: avoid; }
        .sign-area-box {
            border: 2px dashed #BDC3C7; background: #FAFAFA; border-radius: 8px;
            position: relative; height: 220px; margin-top: 10px; 
            cursor: crosshair; overflow: hidden;
            touch-action: none; 
        }
        .sign-placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #BDC3C7; font-size: 1.5rem; font-family: var(--font-serif); pointer-events: none; opacity: 0.5;
        }
        .sign-placeholder::after { content: "( è«‹åœ¨æ­¤è™•ç°½å )"; display: block; font-size: 0.8rem; text-align: center; margin-top: 5px; font-family: var(--font-sans); }
        canvas { display: block; width: 100%; height: 100%; }
        
        .sign-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .date-display { font-family: monospace; color: var(--c-dark); font-weight: bold; }
        .btn-clear { background: none; border: none; color: var(--c-gray); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-clear:hover { color: var(--c-red); }

        .action-area { text-align: center; margin-top: 40px; }
        .btn-submit {
            background-color: var(--c-dark); color: var(--c-gold);
            border: 1px solid var(--c-dark); padding: 18px 60px;
            font-size: 1.1rem; font-weight: bold; letter-spacing: 1px;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2);
            display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-submit:hover { background-color: var(--c-gold); color: white; border-color: var(--c-gold); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(191, 161, 95, 0.3); }
        .btn-submit:disabled { background-color: #BDC3C7; border-color: #BDC3C7; color: white; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .footer { text-align: center; color: #999; font-size: 0.8rem; padding: 40px 0; margin-top: auto; }
        .highlight-error { animation: shake 0.5s; border-color: var(--c-red) !important; background-color: #FDEDEC !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        div:where(.swal2-container) h2:where(.swal2-title) { font-family: var(--font-serif) !important; color: var(--c-dark) !important; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: var(--c-gold) !important; box-shadow: 0 4px 15px rgba(191, 161, 95, 0.4) !important; }

        /* â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ä¿®æ­£ (æ’ç‰ˆé—œéµ) â˜…â˜…â˜… */
        @media (max-width: 768px) {
            #capture-area { padding: 30px 20px; }
            /* å¼·åˆ¶æ‰‹æ©Ÿç‰ˆè®Šæˆå–®æ¬„å †ç–Š */
            .form-grid { grid-template-columns: 1fr; } 
            /* æ‰‹æ©Ÿç‰ˆæ‰€æœ‰æ¬„ä½éƒ½ä½”æ»¿ */
            .col-full { grid-column: span 1; }
            .header-section h1 { font-size: 1.5rem; }
            .house-selector { flex-direction: column; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="#" class="nav-logo">ä½ å¥½å“‡å¯“æ‰€ | æºé ‚æ°‘å®¿</a>
    </nav>

    <div class="header-section">
        <h1>ä½å®¿å¥‘ç´„ç°½ç½²</h1>
        <p>Accommodation Contract</p>
    </div>

    <div class="container">
        <div id="capture-area">
            <div class="contract-header">
                <h2>ä½å®¿å¥‘ç´„æ›¸èˆ‡ç”Ÿæ´»å…¬ç´„</h2>
                <span>Accommodation Agreement & House Rules</span>
            </div>

            <div class="form-grid">
                <div class="form-group col-full">
                    <label class="form-label">å…¥ä½é¤¨åˆ¥ (Select House)</label>
                    <input type="hidden" id="house-select" value="ä½ å¥½å“‡å¯“æ‰€">
                    <div class="house-selector">
                        <div class="house-btn active" onclick="selectHouse('ä½ å¥½å“‡å¯“æ‰€', this)">
                            <h4>ä½ å¥½å“‡å¯“æ‰€</h4>
                            <span>Hello House (ä¸»é¤¨)</span>
                        </div>
                        <div class="house-btn" onclick="selectHouse('æºé ‚æ°‘å®¿', this)">
                            <h4>æºé ‚æ°‘å®¿</h4>
                            <span>Godin House (äºŒé¤¨)</span>
                        </div>
                    </div>
                </div>

                <div class="form-group col-full">
                    <label class="form-label">å…¥ä½æœŸé–“ (Check-in / out)</label>
                    <input type="text" id="date-range-picker" class="form-input readonly" placeholder="è«‹é¸æ“‡æ—¥æœŸ..." readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¨‚æˆ¿äººå§“å (Name)</label>
                    <input type="text" id="booker-name" class="form-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">è¯çµ¡é›»è©± (Phone)</label>
                    <input type="tel" id="booker-phone" class="form-input" placeholder="09xxxxxxxx">
                </div>
            </div>

            <div class="section-title">ä¸€ã€å®šå‹åŒ–å¥‘ç´„æ¢æ¬¾ (è§£ç´„èˆ‡é€€è²»)</div>
            
            <div class="contract-option-box disabled">
                <div class="option-badge">æœ¬æ¡ˆä¸é©ç”¨</div>
                <div style="font-weight:bold; color:#A0AEC0; margin-bottom:5px;">â–¡ æ¯”ä¾‹é€€é‚„é æ”¶ç´„å®šæˆ¿åƒ¹ç¸½é‡‘é¡ï¼š</div>
                <div class="legal-text" style="color:#A0AEC0;">
                    <p>(ä¸€) æ—…å®¢è§£ç´„é€šçŸ¥æ–¼é å®šä½å®¿æ—¥å‰ç¬¬ä¸‰æ—¥ä»¥å‰åˆ°é”è€…ï¼Œæ¥­è€…æ‡‰é€€é‚„é æ”¶ç´„å®šæˆ¿åƒ¹ç¸½é‡‘é¡ç™¾åˆ†ä¹‹ç™¾ã€‚</p>
                    <p>(äºŒ) æ—…å®¢è§£ç´„é€šçŸ¥æ–¼é å®šä½å®¿æ—¥å‰ç¬¬ä¸€æ—¥è‡³ç¬¬äºŒæ—¥åˆ°é”è€…ï¼Œæ¥­è€…æ‡‰é€€é‚„é æ”¶ç´„å®šæˆ¿åƒ¹ç¸½é‡‘é¡ç™¾åˆ†ä¹‹äº”åã€‚</p>
                    <p>(ä¸‰) æ—…å®¢è§£ç´„é€šçŸ¥æ–¼é å®šä½å®¿æ—¥ç•¶æ—¥åˆ°é”æˆ–æœªç‚ºè§£ç´„é€šçŸ¥è€…ï¼Œæ¥­è€…å¾—ä¸é€€é‚„é æ”¶ç´„å®šæˆ¿åƒ¹ç¸½é‡‘é¡ã€‚</p>
                </div>
            </div>

            <div class="contract-option-box">
                <div class="option-badge">é›™æ–¹åˆæ„é©ç”¨</div>
                <div style="font-weight:bold; color:var(--c-dark); margin-bottom:5px;">â–¡ ä¸€å¹´å…§ä¿ç•™å·²ä»˜é‡‘é¡ä½œç‚ºæ—¥å¾Œæ¶ˆè²»æŠ˜æŠµä½¿ç”¨ï¼š</div>
                <div class="legal-text">
                    <p>(ä¸€) æ—…å®¢è§£ç´„é€šçŸ¥æ–¼é å®šä½å®¿æ—¥ç•¶æ—¥å‰åˆ°é”è€…ï¼Œå¾—æ–¼ä¸€å¹´å…§ä¿ç•™å·²ä»˜é‡‘é¡ä½œç‚ºæ—¥å¾Œæ¶ˆè²»æŠ˜æŠµä½¿ç”¨ã€‚</p>
                    <p>(äºŒ) æ—…å®¢è§£ç´„é€šçŸ¥æ–¼é å®šä½å®¿æ—¥ç•¶æ—¥åˆ°é”æˆ–æœªç‚ºè§£ç´„é€šçŸ¥è€…ï¼Œæ¥­è€…å¾—ä¸é€€é‚„é æ”¶ç´„å®šæˆ¿åƒ¹ç¸½é‡‘é¡ã€‚</p>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#888; border-top:1px dashed #DDD; padding-top:8px;">
                    * æ—…å®¢åŒæ„ä»¥å„ªæƒ åƒ¹æ ¼é è¨‚ï¼Œé›™æ–¹åˆæ„åƒ…ä¾æ­¤æ¢æ¬¾ä½œç‚ºè§£ç´„è™•ç†æ–¹å¼ã€‚
                </div>
            </div>

            <div class="section-title">äºŒã€ä½å®¿ç”Ÿæ´»å…¬ç´„ (è«‹è©³é–±)</div>
            <ul class="rules-list">
                <li class="rule-item">
                    <div class="rule-icon"><i class="fa-solid fa-users"></i></div>
                    <div class="rule-content">
                        <h4>è¨‚æˆ¿èˆ‡æŠ¼é‡‘é ˆçŸ¥</h4>
                        <p>è«‹ä¾å¯¦éš›è¨‚æˆ¿äººæ•¸å…¥ä½ï¼Œè¶…å‡ºé å®šäººæ•¸å…¥ä½éƒ¨åˆ†åŠ æ”¶æ¯äºº <span class="highlight">$1,800/æ—¥</span>ï¼Œå¦‚éœ€è¦åŠ äºº(åºŠ)ï¼Œè«‹æ–¼å…¥ä½å‰ä¸€æ—¥å‘ŠçŸ¥ï¼Œä¸¦åŠ æ”¶è¶…å‡ºé å®šäººæ•¸æ¯äºº <span class="highlight">$1,000/æ—¥</span>ï¼ˆå‡æ—¥æˆ–é€£çºŒå‡æœŸç‚ºæ¯äºº <span class="highlight">$1,500/æ—¥</span>ï¼‰ã€‚</p>
                        <p style="margin-top:5px;"><strong>æŠ¼é‡‘è¦å®šï¼š</strong>ç‚ºç¢ºä¿é›™æ–¹æ¬Šç›Šï¼Œè¾¦ç†å…¥ä½æ™‚éœ€æ”¶å–æŠ¼é‡‘ <span class="highlight">$5,000</span>ã€‚æ–¼é€€æˆ¿å¾Œç¢ºèªç„¡ä»»ä½•è¨­å‚™æå£ï¼Œä¸”æœªé•åå…¥ä½é ˆçŸ¥ï¼ˆå«éæ–¼é«’äº‚ï¼‰å¾Œå…¨æ•¸åŒ¯æ¬¾é€€é‚„ã€‚</p>
                    </div>
                </li>
                <li class="rule-item">
                    <div class="rule-icon"><i class="fa-solid fa-clock"></i></div>
                    <div class="rule-content">
                        <h4>é€²é€€æˆ¿æ™‚é–“</h4>
                        <p>é€²æˆ¿æ™‚é–“ï¼šå…¥ä½ç•¶æ—¥ <strong>16:00</strong> ä»¥å¾Œã€‚(è‹¥æƒ…æ³å…è¨±ï¼Œå¯ç¶“ç”±æ°‘å®¿ä¸»äººåŒæ„å¾Œææ—©å…¥ä½ã€‚å…¥ä½æ™‚è«‹å‡ºç¤ºèº«åˆ†è­‰æˆ–è­·ç…§è¾¦ç†ä½å®¿ç™»è¨˜ï¼Œä¸¦ç•¶å ´ç¹³æ¸…é¤˜æ¬¾ã€‚æœ€æ™šè«‹æ–¼å…¥ä½ç•¶æ—¥ 21:00 å‰å®Œæˆæ‰‹çºŒ)</p>
                        <p>é€€æˆ¿æ™‚é–“ï¼šé€€æˆ¿ç•¶æ—¥ <strong>11:00</strong> ä»¥å‰ã€‚æœªç¶“æ°‘å®¿ä¸»äººåŒæ„å»¶é²é€€æˆ¿ï¼Œä¸€å°æ™‚åŠ æ”¶ <span class="highlight">$1,500</span>ï¼Œè¶…éäº”å°æ™‚ä»¥ä¸€æ—¥åŒ…æ£Ÿå®šåƒ¹è¨ˆç®—ã€‚</p>
                    </div>
                </li>
                <li class="rule-item warning">
                    <div class="rule-icon"><i class="fa-solid fa-ban"></i></div>
                    <div class="rule-content">
                        <h4 style="color:var(--c-red);">åš´æ ¼ç¦æ­¢äº‹é … (é•è€…å ±è­¦/æ‰£æ¬¾)</h4>
                        <p>æœ¬æ°‘å®¿å…¨æ£Ÿç¦æ­¢<strong>ã€Œå¸è¸ã€ã€ã€Œå¸æ¯’ã€ã€ã€Œè³­åšã€ã€ã€Œåš¼æª³æ¦”ã€ã€ã€Œç‡ƒæ”¾çˆ†ç«¹ã€</strong>åŠä»»ä½•é•åå–„è‰¯é¢¨ä¿—ä¹‹ä¸æ³•è¡Œç‚ºã€‚å¦‚æœ‰æŠ½è¸éœ€æ±‚è«‹è‡³ä¸€æ¨“æˆ¶å¤–å€ã€‚è‹¥æœ‰é•æ³•è¡Œç‚ºå°‡ç›´æ¥å ±è­¦è™•ç†ä¸å¦è¡Œé€šçŸ¥ã€‚</p>
                        <p style="margin-top:5px;">æœ¬æ—…å®¿<strong>éå¯µç‰©å‹å–„æ—…å®¿</strong>ï¼Œåˆ‡å‹¿æ”œå¸¶å¯µç‰©å…¥ä½ï¼ˆäº‹å‰è©¢å•ä¸”ç¶“æ¥­ä¸»åŒæ„*ä¸æ¥å—å…¥ä½ç•¶å¤©è©¢å•*æ”œå¸¶å¯µç‰©å…¥ä½è€…ï¼Œé…Œæ”¶æ¸…æ½”è²» <span class="highlight">$800/å¹³æ—¥ã€$1000/å‡æ—¥</span>ï¼Œä¸”é€ æˆæå£ä»éœ€ç…§åƒ¹è³ å„Ÿï¼‰ã€‚</p>
                        <p style="margin-top:5px;">é™¤ç•¶æ—¥å…¥ä½æˆ¿å®¢ä¹‹å¤–ï¼Œæ•ä¸å°å¤–é–‹æ”¾åƒè§€ï¼Œä¸”åš´ç¦éç•¶æ—¥å…¥ä½æˆ¿å®¢ä»¥å¤–äººå£«é€²å…¥ã€‚åŒ…æ£Ÿé–‹æ”¾å€åŸŸç‚ºä¸€æ¨“å»šæˆ¿èˆ‡æ‰€é–‹ç«‹ä¹‹æˆ¿é–“å¤–ï¼Œå…¶é¤˜åœ°æ–¹(åŒ…å«é ‚æ¨“éœ²å°èˆ‡é€šå¾€é ‚æ¨“ä¹‹æ¨“æ¢¯é–“)ç‚ºå±‹ä¸»ç§äººç©ºé–“ï¼Œæœªç¶“åŒæ„åš´ç¦äººå“¡é€²å…¥ï¼Œè‹¥ç¶“ç™¼ç¾å°‡é€•è¡Œä¾æ³•(åˆ‘æ³•306æ¢)è™•ç†ã€‚</p>
                    </div>
                </li>
                <li class="rule-item">
                    <div class="rule-icon"><i class="fa-solid fa-sink"></i></div>
                    <div class="rule-content">
                        <h4>å‚™å“èˆ‡ç¶­è­·</h4>
                        <p>æ°‘å®¿ä¸ä¸»å‹•æä¾›æ›´æ›æ•å¥—ã€åºŠå–®ã€æµ´å·¾ç­‰å‚™å“ã€‚é€£çºŒå…¥ä½ä¹‹æˆ¿å®¢ï¼ŒåŸå‰‡ä¸Šæä¾›æ¯3æ—¥æ›´æ›ä¸€æ¬¡æµ´å·¾ä¹‹å…è²»æœå‹™ã€‚</p>
                        <p>é–‹æ”¾å¼å®¢å»³ä¹‹è¨­å‚™æ–¼å…¥ä½æœŸé–“å…è²»æä¾›ä½¿ç”¨ï¼ŒæƒŸä½¿ç”¨å¾Œè«‹æ¢å¾©åŸè²ŒåŠå¦¥å–„æ¸…æ½”ï¼Œä¸¦è«‹éš¨æ‰‹é—œç‡ˆã€å†·æ°£åŠç¯€ç´„ç”¨æ°´ï¼Œæœªéµå®ˆè€…è¦–æƒ…æ³æ‰£é™¤æŠ¼é‡‘ã€‚</p>
                    </div>
                </li>
                <li class="rule-item">
                    <div class="rule-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="rule-content">
                        <h4>å®‰å…¨ã€å®‰å¯§èˆ‡è³ å„Ÿ</h4>
                        <p><strong>å®‰å¯§æ™‚é–“ï¼š</strong>ä½æ–¼ä½å®…å€ï¼Œ<span class="highlight">23:00è‡³éš”æ—¥08:00</span> è«‹é™ä½éŸ³é‡ï¼Œå‹¿å¤§è²å–§å˜©ã€‚è‹¥ç¶“å±¢å‹¸ç„¡æ•ˆå‰‡è¦æ±‚ç«‹å³é€€æˆ¿ï¼Œæ•ç„¡é€€é‚„æˆ¿è²»ã€‚</p>
                        <p><strong>è³ å„Ÿåƒ¹ç›®è¡¨ï¼š</strong>
                            <ul>
                                <li>å¯¢å…·ç”¨å“æ²¾ä¸Šè¡€æ¼¬ã€å˜”åç‰©ç­‰ï¼Œæ”¶å–ç‰¹æ®Šæ¸…æ½”è²» <span class="highlight">500ï½2,000å…ƒ</span>ã€‚</li>
                                <li>å…¬å…±ç©ºé–“ä½¿ç”¨å®Œç•¢è‹¥æœªå¦¥å–„å¾©åŸï¼Œå°‡è¦–æƒ…æ³æ”¶å–é¡å¤–æ¸…æ½”è²»ç”¨ <span class="highlight">500ï½5,000å…ƒ</span>ã€‚</li>
                                <li><strong>è‹¥ç™¼ç¾å®¤å…§å¸ç…™è¡Œç‚ºï¼Œç›´æ¥æ‰£é™¤å…¨é¡æŠ¼é‡‘ <span class="highlight">5,000å…ƒ</span> ä½œç‚ºæ¸…æ½”è²»ã€‚</strong></li>
                            </ul>
                        </p>
                    </div>
                </li>
            </ul>
            
            <div style="background:#2C3E50; color:#FFF; padding:15px; font-size:0.85rem; border-radius:4px; margin-top:20px; line-height:1.5; text-align:justify;">
                <i class="fa-solid fa-circle-info" style="color:var(--c-gold); margin-right:5px;"></i>
                <strong>è¦ç¯„é™åˆ¶è²æ˜ï¼š</strong>åœ¨æ‚¨è¨‚æˆ¿çš„åŒæ™‚ï¼Œå°‡è¦–åŒäº†è§£ä¸¦æ¥å—ä¸Šè¿°å®‰å…¨è¦å®šèˆ‡é™åˆ¶ï¼Œè‹¥é•åä¸Šè¿°é™åˆ¶èˆ‡è¦å®šè‚‡ç”Ÿä»»ä½•æ„å¤–ï¼Œä¸å¾—å°æ°‘å®¿èˆ‡æ°‘å®¿è² è²¬äººé€²è¡Œä»»ä½•ä¹‹ç©¶è²¬èˆ‡ç´¢è³ è¡Œç‚ºã€‚
            </div>

            <div class="signature-section">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                    <div style="font-weight:bold; font-family:var(--font-serif); font-size:1.1rem;">æ—…å®¢ç°½å / Signature</div>
                    <div style="font-size:0.8rem; color:#888;">æœ¬äººå·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°æ‰€æœ‰æ¢æ¬¾</div>
                </div>
                
                <div class="sign-area-box" id="sign-wrapper">
                    <span class="sign-placeholder">Sign Here</span>
                    <canvas id="signature-canvas"></canvas>
                </div>
                
                <div class="sign-tools">
                    <div id="date-display" class="date-display"></div>
                    <button class="btn-clear" onclick="clearPad()">
                        <i class="fa-solid fa-eraser"></i> æ¸…é™¤é‡ç°½
                    </button>
                </div>
            </div>
        </div>

        <div class="action-area">
            <button id="btn-submit" class="btn-submit" onclick="submitContract()">
                <span id="btn-text">ç¢ºèªç°½ç½²ä¸¦é€å‡ºåˆç´„</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            <p style="font-size:0.85rem; color:#999; margin-top:15px;">
                <i class="fa-solid fa-shield-halved"></i> ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆé«˜è§£æ PDF ä¸¦åŠ å¯†å‚³è¼¸
            </p>
        </div>
    </div>

    <footer class="footer">
        Â© 2025 ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿. All Rights Reserved.
    </footer>

    <script>
        // è¨­å®šå€
        const GAS_APP_URL = "https://script.google.com/macros/s/AKfycbzfqpbILo5s6P0593PcdpYVie5cbyYGhxe83-Xbzs5QHymN6uNwo37ziT0As6zj1tZk1w/exec";
        const MY_LIFF_ID = "2008582194-vLLGoM4M"; 

        const { jsPDF } = window.jspdf;
        let datePicker;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof liff !== 'undefined') { liff.init({ liffId: MY_LIFF_ID }).catch(err => console.error(err)); }
            datePicker = flatpickr("#date-range-picker", { mode: "range", minDate: "today", dateFormat: "Y-m-d", conjunction: " è‡³ ", locale: "zh_tw" });
            initSignaturePad();
        });

        function selectHouse(value, element) {
            document.getElementById('house-select').value = value;
            document.querySelectorAll('.house-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        let hasSigned = false;

        function initSignaturePad() {
            const wrapper = document.getElementById('sign-wrapper');
            function resize() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = wrapper.offsetWidth * ratio;
                canvas.height = wrapper.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
            }
            window.addEventListener('resize', resize);
            resize(); 
            let isDrawing = false;
            
            // â˜…â˜…â˜… é—œéµï¼šé˜²æ­¢æ‰‹æ©Ÿç°½åæ™‚ç•«é¢æ»‘å‹• â˜…â˜…â˜…
            const start = (e) => { 
                if(e.type === 'touchstart') e.preventDefault();
                isDrawing = true; hasSigned = true; 
                document.querySelector('.sign-placeholder').style.display = 'none'; 
                ctx.beginPath(); draw(e); 
            };
            const end = () => { isDrawing = false; ctx.beginPath(); };
            const draw = (e) => {
                if(!isDrawing) return;
                if(e.type === 'touchmove') e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                let x = (e.clientX || e.touches[0].clientX) - rect.left;
                let y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', end);
        }

        function clearPad() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelector('.sign-placeholder').style.display = 'block';
            hasSigned = false;
        }

        async function submitContract() {
            const name = document.getElementById('booker-name').value.trim();
            const phone = document.getElementById('booker-phone').value.trim();
            const house = document.getElementById('house-select').value;
            const phoneRegex = /^09\d{8}$/;

            if (!datePicker || datePicker.selectedDates.length !== 2) return alertAndFocus("è«‹é¸æ“‡ã€Œå…¥ä½èˆ‡é€€æˆ¿æ—¥æœŸã€", "date-range-picker");
            if (!name) return alertAndFocus("è«‹è¼¸å…¥è¨‚æˆ¿äººå§“å", "booker-name");
            if (!phoneRegex.test(phone)) return alertAndFocus("è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼", "booker-phone");
            if (!hasSigned) return alertAndFocus("è«‹åœ¨ç°½åæ¬„ä½ç°½å", "sign-wrapper");

            const now = new Date();
            document.getElementById('date-display').innerText = "Date: " + now.toLocaleDateString('en-CA');
            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            
            btn.disabled = true;
            btnText.innerHTML = 'æ­£åœ¨ç”Ÿæˆåˆç´„...';

            try {
                const dateVal = document.getElementById('date-range-picker').value;
                const cleanDate = dateVal.split(' è‡³ ')[0].replace(/-/g, '');
                const fileName = `${cleanDate}_${house}_${name}_${phone}.pdf`;

                const captureArea = document.getElementById("capture-area");
                
                // â˜…â˜…â˜… æ™ºæ…§åµæ¸¬ï¼šæ‰‹æ©Ÿç”¨ scale 2 é¿å…è¨˜æ†¶é«”ä¸è¶³ï¼Œé›»è…¦ç”¨ scale 3 é«˜ç•«è³ª â˜…â˜…â˜…
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const scale = isMobile ? 2 : 3;

                const canvasData = await html2canvas(captureArea, { 
                    scale: scale, 
                    useCORS: true, 
                    backgroundColor: "#ffffff", 
                    logging: false 
                });
                const imgData = canvasData.toDataURL('image/jpeg', 0.6);
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                if (imgHeight > pdf.internal.pageSize.getHeight()) {
                    const longPdf = new jsPDF('p', 'mm', [pdfWidth, imgHeight + 10]);
                    longPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = longPdf.output('datauristring');
                } else {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = pdf.output('datauristring');
                }

                btnText.innerHTML = 'åŠ å¯†ä¸Šå‚³é›²ç«¯...';

                const response = await fetch(GAS_APP_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ type: "UPLOAD_IMG", image: pdfBase64, filename: fileName, user: name })
                });

                const textResponse = await response.text();
                let result;
                try { result = JSON.parse(textResponse); } catch(e) { throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤"); }

                if (result.status === "success") {
                    const downloadLink = result.url;
                    
                    if (liff.isInClient()) {
                        const flexMessage = {
                            "type": "flex",
                            "altText": "âœ… æ‚¨çš„ä½å®¿å¥‘ç´„æ›¸å·²ç°½ç½²å®Œæˆ",
                            "contents": {
                                "type": "bubble",
                                "size": "mega",
                                "header": {
                                    "type": "box",
                                    "layout": "vertical",
                                    "backgroundColor": "#2C3E50",
                                    "paddingAll": "xl",
                                    "contents": [
                                        { "type": "text", "text": "âœ… ç°½ç´„å®Œæˆç¢ºèª", "color": "#BFA15F", "weight": "bold", "size": "lg", "align": "center" },
                                        { "type": "text", "text": "OFFICIAL CONTRACT SIGNED", "color": "#95A5A6", "size": "xxs", "align": "center", "margin": "xs", "letterSpacing": "1px" }
                                    ]
                                },
                                "body": {
                                    "type": "box",
                                    "layout": "vertical",
                                    "paddingAll": "xl",
                                    "contents": [
                                        { "type": "text", "text": `æ„Ÿè¬æ‚¨ï¼Œ${name} è²´è³“`, "weight": "bold", "size": "lg", "color": "#2C3E50" },
                                        { "type": "text", "text": "æ‚¨çš„å…¥ä½åˆç´„å·²å®Œæˆç°½ç½²ä¸¦åŠ å¯†æ­¸æª”ã€‚", "size": "sm", "color": "#7F8C8D", "margin": "sm" },
                                        { "type": "separator", "margin": "xl" },
                                        {
                                            "type": "box", "layout": "vertical", "margin": "xl", "spacing": "sm",
                                            "contents": [
                                                { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ  é¤¨åˆ¥", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": house, "wrap": true, "color": "#2C3E50", "size": "sm", "flex": 5, "weight": "bold" }] },
                                                { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“… å…¥ä½", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": dateVal.split(' è‡³ ')[0], "color": "#2C3E50", "size": "sm", "flex": 5 }] }
                                            ]
                                        },
                                        { "type": "separator", "margin": "xl" },
                                        { "type": "text", "text": "ğŸ“¥ åˆç´„å‰¯æœ¬ä¸‹è¼‰", "size": "xs", "color": "#95A5A6", "margin": "xl", "align": "center", "letterSpacing":"1px" },
                                        {
                                            "type": "button",
                                            "style": "primary",
                                            "height": "sm",
                                            "color": "#BFA15F",
                                            "margin": "md",
                                            "action": { "type": "uri", "label": "é»æ­¤ä¸‹è¼‰å¥‘ç´„æ›¸ PDF", "uri": downloadLink }
                                        },
                                        { "type": "text", "text": "âš ï¸ é€£çµ 15 å¤©å…§æœ‰æ•ˆï¼Œè«‹ç›¡é€Ÿä¸‹è¼‰ç•™å­˜ã€‚", "size": "xxs", "color": "#E74C3C", "margin": "md", "wrap": true, "align": "center", "weight": "bold" }
                                    ]
                                }
                            }
                        };

                        await liff.sendMessages([flexMessage]);
                        await Swal.fire({ icon: 'success', title: 'ç°½ç½²å®Œæˆ', text: 'åˆç´„å·²å‚³é€è‡³ LINE', confirmButtonColor: '#2C3E50', timer: 3000, timerProgressBar: true });
                        liff.closeWindow();
                        
                    } else {
                        Swal.fire({
                            icon: 'success', title: 'ç°½ç´„æˆåŠŸï¼',
                            html: `<a href="${downloadLink}" target="_blank" style="display:block; background:#BFA15F; color:white; padding:15px; border-radius:50px; text-decoration:none; font-weight:bold; margin-top:20px;">ä¸‹è¼‰åˆç´„ PDF</a>`,
                            showConfirmButton: false, showCloseButton: true, width: '450px'
                        });
                    }
                } else { throw new Error(result.msg || "ä¸Šå‚³å¤±æ•—"); }
            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'ä¸Šå‚³å¤±æ•—', text: err.message, confirmButtonColor: '#d33' });
            } finally {
                btn.disabled = false;
                btnText.innerHTML = "ç¢ºèªç°½ç½²ä¸¦é€å‡ºåˆç´„";
            }
        }

        function alertAndFocus(msg, id) {
            Swal.fire({ icon: 'warning', title: 'è«‹æª¢æŸ¥æ¬„ä½', text: msg, confirmButtonColor: '#BFA15F' }).then(() => {
                const el = document.getElementById(id);
                if(el) { el.scrollIntoView({behavior: "smooth", block: "center"}); el.classList.add('highlight-error'); setTimeout(() => el.classList.remove('highlight-error'), 1500); }
            });
        }
    </script>
</body>
</html>