<script>
        // â˜…â˜…â˜… å·²æ›´æ–°ç‚ºæ‚¨çš„æœ€æ–° GAS ç¶²å€ â˜…â˜…â˜…
        const GAS_APP_URL = "https://script.google.com/macros/s/AKfycbzfqpbILo5s6P0593PcdpYVie5cbyYGhxe83-Xbzs5QHymN6uNwo37ziT0As6zj1tZk1w/exec";
        const MY_LIFF_ID = "2008582194-vLLGoM4M"; 

        // åˆå§‹åŒ–
        const { jsPDF } = window.jspdf;
        let datePicker;

        document.addEventListener('DOMContentLoaded', function() {
            // 1. åˆå§‹åŒ– LIFF
            if (typeof liff !== 'undefined') {
                liff.init({ liffId: MY_LIFF_ID }).catch(err => console.error("LIFF Error:", err));
            }

            // 2. æ—¥æœŸé¸æ“‡å™¨
            datePicker = flatpickr("#date-range-picker", {
                mode: "range",
                minDate: "today",
                dateFormat: "Y-m-d",
                conjunction: " è‡³ ",
                locale: "zh_tw"
            });

            // 3. ç°½åæ¿åˆå§‹åŒ–
            initSignaturePad();
        });

        // ç°½åæ¿é‚è¼¯
        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        const hint = document.getElementById('sign-hint');
        let hasSigned = false;

        function initSignaturePad() {
            const wrapper = document.getElementById('sign-wrapper');
            function resize() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = wrapper.offsetWidth * ratio;
                canvas.height = wrapper.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
            }
            window.addEventListener('resize', resize);
            resize();

            let isDrawing = false;
            const start = (e) => { isDrawing = true; hasSigned = true; hint.style.display = 'none'; ctx.beginPath(); draw(e); };
            const end = () => { isDrawing = false; ctx.beginPath(); };
            const draw = (e) => {
                if(!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if(e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', end);
        }

        function clearPad() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hint.style.display = 'block';
            hasSigned = false;
        }

        // â˜…â˜…â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ PDF ä¸¦ä¸Šå‚³ (å«é™¤éŒ¯æ¨¡å¼) â˜…â˜…â˜…
        async function submitContract() {
            // --- è‡ªå‹•å¡«å…¥æ¸¬è©¦è³‡æ–™ (è‹¥ç•™ç©º) ---
            let name = document.getElementById('booker-name').value.trim();
            let phone = document.getElementById('booker-phone').value.trim();
            const house = document.getElementById('house-select').value;
            
            // æ¸¬è©¦ç”¨ï¼šå¦‚æžœæ²’å¡«ï¼Œè‡ªå‹•è£œä¸Š
            if (!name) { name = "æ¸¬è©¦äººå“¡"; document.getElementById('booker-name').value = name; }
            if (!phone) { phone = "0900000000"; document.getElementById('booker-phone').value = phone; }
            if (datePicker.selectedDates.length !== 2) {
                // è‡ªå‹•è¨­ç‚ºä»Šå¤©åˆ°æ˜Žå¤©
                datePicker.setDate([new Date(), new Date(new Date().getTime() + 86400000)]);
            }
            
            // æ¨™è¨˜ç°½å (å³ä½¿æ²’ç°½ä¹Ÿè®“ä»–éŽï¼Œç‚ºäº†æ¸¬è©¦é€£ç·š)
            hasSigned = true; 

            // æ›´æ–°æ™‚é–“èˆ‡éŽ–å®šæŒ‰éˆ•
            const now = new Date();
            document.getElementById('date-display').innerText = "ç°½ç½²æ™‚é–“ï¼š" + now.toLocaleString('zh-TW');
            
            const btn = document.getElementById('btn-submit');
            const btnText = btn.querySelector('.btn-text');
            btn.disabled = true;
            btn.classList.add('generating');
            
            let pdfBase64 = "";
            let fileName = "";

            // --- éšŽæ®µä¸€ï¼šç”Ÿæˆ PDF ---
            try {
                btnText.innerText = "1/2 ç”Ÿæˆ PDF ä¸­...";
                const dateVal = document.getElementById('date-range-picker').value;
                const checkInDate = dateVal ? dateVal.split(' è‡³ ')[0].replace(/-/g, '') : "20250101";
                fileName = `${checkInDate}_${house}_${name}_${phone}.pdf`;

                const captureArea = document.getElementById("capture-area");
                
                // ä½¿ç”¨è¼ƒä½Žè§£æžåº¦ä»¥ç¢ºä¿æˆåŠŸ
                const canvasData = await html2canvas(captureArea, { 
                    scale: 1, 
                    useCORS: true, // å…è¨±è·¨åŸŸåœ–ç‰‡
                    backgroundColor: "#ffffff",
                    logging: false
                });
                
                const imgData = canvasData.toDataURL('image/jpeg', 0.6);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                if (imgHeight > pdf.internal.pageSize.getHeight()) {
                    const longPdf = new jsPDF('p', 'mm', [pdfWidth, imgHeight + 10]);
                    longPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    pdfBase64 = longPdf.output('datauristring');
                } else {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    pdfBase64 = pdf.output('datauristring');
                }
                
                console.log("PDF ç”ŸæˆæˆåŠŸï¼Œé•·åº¦:", pdfBase64.length);

            } catch (err) {
                console.error("ç”Ÿæˆ PDF å¤±æ•—", err);
                alert("âŒ ç”Ÿæˆ PDF å¤±æ•—ï¼\nåŽŸå› ï¼š" + err.message);
                resetBtn();
                return;
            }

            // --- éšŽæ®µäºŒï¼šä¸Šå‚³è‡³ GAS ---
            try {
                btnText.innerText = "2/2 ä¸Šå‚³é›²ç«¯ä¸­...";
                
                // ä½¿ç”¨ text/plain é¿å… CORS Preflight å•é¡Œ
                const response = await fetch(GAS_APP_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        type: "UPLOAD_IMG",
                        image: pdfBase64,
                        filename: fileName,
                        user: name
                    })
                });

                // å–å¾—åŽŸå§‹å›žå‚³æ–‡å­— (æ–¹ä¾¿é™¤éŒ¯)
                const responseText = await response.text();
                console.log("GAS å›žå‚³:", responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    // å¦‚æžœè§£æžå¤±æ•—ï¼Œé€šå¸¸æ˜¯å› ç‚º GAS å›žå‚³äº†éŒ¯èª¤ç¶²é  (HTML)
                    throw new Error("GAS å›žå‚³æ ¼å¼éŒ¯èª¤ (éž JSON)ã€‚\nå…§å®¹ï¼š" + responseText.substring(0, 150));
                }

                if (result.status === "success") {
                    const downloadLink = result.url;
                    
                    if (liff.isInClient()) {
                        await liff.sendMessages([{
                            type: "flex",
                            altText: "ðŸ“„ æ‚¨æœ‰ä¸€ä»½ç°½ç½²å®Œæˆçš„åˆç´„",
                            contents: {
                                "type": "bubble",
                                "size": "mega",
                                "body": {
                                    "type": "box", "layout": "vertical",
                                    "contents": [
                                        { "type": "text", "text": "âœ… ç·šä¸Šç°½ç½²å®Œæˆ", "weight": "bold", "color": "#1DB446", "size": "sm" },
                                        { "type": "text", "text": "ä½å®¿å¥‘ç´„æ›¸", "weight": "bold", "size": "xl", "margin": "md" },
                                        { "type": "text", "text": fileName, "size": "xxs", "color": "#aaaaaa", "wrap": true, "margin": "xs" },
                                        { "type": "separator", "margin": "lg" },
                                        { "type": "text", "text": "è«‹é»žæ“Šä¸‹æ–¹æŒ‰éˆ•ä¸‹è¼‰ç•™å­˜", "size": "xs", "color": "#666", "margin": "lg", "align": "center" }
                                    ]
                                },
                                "footer": {
                                    "type": "box", "layout": "vertical", "spacing": "sm",
                                    "contents": [
                                        { "type": "button", "style": "primary", "height": "sm", "color": "#C5A065", "action": { "type": "uri", "label": "ðŸ“¥ ä¸‹è¼‰åˆç´„ PDF", "uri": downloadLink } }
                                    ]
                                }
                            }
                        }]);
                        liff.closeWindow();
                    } else {
                        alert("âœ… ä¸Šå‚³æˆåŠŸï¼\n\næª”æ¡ˆé€£çµï¼š" + downloadLink);
                    }
                } else {
                    throw new Error("GAS åŸ·è¡ŒéŒ¯èª¤: " + (result.msg || "æœªçŸ¥åŽŸå› "));
                }

            } catch (err) {
                console.error("ä¸Šå‚³å¤±æ•—", err);
                alert("âŒ ä¸Šå‚³å¤±æ•—ï¼\nåŽŸå› ï¼š" + err.message);
            } finally {
                resetBtn();
            }
        }

        function resetBtn() {
            const btn = document.getElementById('btn-submit');
            btn.disabled = false;
            btn.classList.remove('generating');
            btn.querySelector('.btn-text').innerText = "âœ… ç¢ºèªç°½ç½²ä¸¦å›žå‚³";
        }

        function alertAndFocus(msg, id) {
            alert(msg);
            const el = document.getElementById(id);
            if(el) {
                el.scrollIntoView({behavior: "smooth", block: "center"});
                el.classList.add('highlight-error');
                setTimeout(() => el.classList.remove('highlight-error'), 1500);
            }
        }
    </script>