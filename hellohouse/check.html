<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>å³æ™‚æˆ¿æ³èˆ‡å ±åƒ¹ | ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿</title>
<meta name="robots" content="noindex, nofollow">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    :root { 
        --c-dark: #2C3E50; --c-gold: #BFA15F; --c-gold-light: #F9F5EB; 
        --c-red: #A94442; --c-gray: #7F8C8D; --c-white: #FFFFFF; 
        --font-serif: 'Noto Serif TC', serif; --font-sans: 'Noto Sans TC', sans-serif; 
        --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.06); 
    }
    *, *::before, *::after { box-sizing: border-box; }
    
    body { margin: 0; font-family: var(--font-sans); background-color: #F5F5F5; color: var(--c-dark); line-height: 1.7; display: flex; flex-direction: column; min-height: 100vh; padding-top: 60px; }

    /* å…¨å± Loading é®ç½© (çµ¦è‡ªå‹•å‚³é€ç”¨) */
    #auto-send-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff; z-index: 9999; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        text-align: center;
    }

    .navbar { background: var(--c-dark); height: 60px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; width: 100%; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-logo { color: var(--c-gold); font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-decoration: none; }

    .header-section { padding: 40px 20px; text-align: center; background: var(--c-dark); color: white; margin-bottom: 30px; }
    .header-section h1 { margin: 0; font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 3px; font-weight: 500; }
    .header-section p { margin: 5px 0 0; font-size: 0.8rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 2px; }

    .container { width: 95%; max-width: 800px; margin: -50px auto 40px; position: relative; z-index: 10; }
    .inquiry-card { background-color: var(--c-white); padding: 40px; border-radius: 4px; box-shadow: var(--shadow-card); border-top: 6px solid var(--c-gold); }

    .section-title { font-family: var(--font-serif); font-size: 1.2rem; color: var(--c-dark); margin: 30px 0 20px; padding-left: 15px; border-left: 4px solid var(--c-gold); display: flex; align-items: center; justify-content: space-between; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.85rem; color: var(--c-gray); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { width: 100%; padding: 12px; font-size: 1rem; color: var(--c-dark); font-family: var(--font-serif); border: 1px solid #DDD; border-radius: 4px; background: #FAFAFA; transition: 0.3s; }
    .form-input:focus { outline: none; border-color: var(--c-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1); }
    .form-input.readonly { background: #fff; cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23BFA15F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>'); background-repeat: no-repeat; background-position: right 15px center; }

    .btn-submit { background-color: var(--c-dark); color: var(--c-gold); border: 1px solid var(--c-dark); padding: 15px 40px; font-size: 1rem; font-weight: bold; letter-spacing: 1px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
    .btn-submit:hover { background-color: var(--c-gold); color: white; border-color: var(--c-gold); transform: translateY(-2px); }
    .btn-submit:disabled { background-color: #BDC3C7; border-color: #BDC3C7; color: white; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-search { background-color: var(--c-gold); color: white; border-color: var(--c-gold); }
    .btn-search:hover { background-color: #A68550; border-color: #A68550; }

    .venue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .venue-card { padding: 15px; border: 1px solid #DDD; border-radius: 6px; background: #FAFAFA; cursor: pointer; transition: 0.3s; text-align: center; position: relative; }
    .venue-card h4 { margin: 0; font-size: 1rem; color: var(--c-dark); font-weight: bold; font-family: var(--font-serif); }
    .venue-card span { font-size: 0.8rem; color: #999; display: block; margin-top: 5px; }
    .venue-card.available { border-color: var(--c-gold); background: #FFF; }
    .venue-card.available:hover { background: var(--c-gold-light); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(191, 161, 95, 0.15); }
    .venue-card.available .status-badge { color: var(--c-gold); font-weight: bold; font-size: 0.8rem; margin-top: 5px; }
    .venue-card.disabled { opacity: 0.6; cursor: not-allowed; background: #EEE; border-style: dashed; }
    .venue-card.disabled .status-badge { color: var(--c-red); margin-top: 5px; font-size: 0.8rem; font-weight: bold; }

    .recommendation-box { margin-top: 25px; border: 1px dashed #A68550; background: #FFFCF5; padding: 20px; border-radius: 6px; display: none; animation: fadeIn 0.5s; }
    .rec-title { font-size: 0.95rem; color: #A68550; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px dashed #E0D6C3; padding-bottom: 8px;}
    .rec-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #EED; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .rec-item:hover { border-color: var(--c-gold); transform: translateX(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .rec-tag { background: #E74C3C; color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 3px; margin-right: 8px; font-weight: bold; }
    .rec-tag.part { background: #F39C12; }

    .plan-grid { display: grid; gap: 15px; }
    .plan-card { border: 1px solid #DDD; background-color: #FFF; padding: 20px; border-radius: 6px; position: relative; cursor: pointer; transition: 0.3s; }
    .plan-card:hover { border-color: var(--c-gold); background: #FFFCF5; }
    .plan-card.selected { border: 2px solid var(--c-gold); background-color: var(--c-gold-light); box-shadow: 0 4px 15px rgba(191, 161, 95, 0.2); }
    .plan-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -10px; right: -5px; background: var(--c-gold); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
    .plan-capacity { position: absolute; top: 15px; right: 15px; background: #EDF2F7; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; color: #555; font-weight: bold; }
    .plan-title { font-weight: bold; color: var(--c-dark); font-size: 1.1rem; font-family: var(--font-serif); margin-bottom: 5px; }
    .plan-detail { font-size: 0.85rem; color: #7F8C8D; margin-bottom: 10px; border-top: 1px solid #EEE; padding-top: 8px; margin-top: 8px; }
    .plan-price { font-size: 1.1rem; color: var(--c-gold); font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .plan-price small { font-size: 0.75rem; color: #999; font-weight: normal; }

    .step-section { display: none; opacity: 0; transition: opacity 0.5s ease; border-top: 1px dashed #EEE; margin-top: 30px; padding-top: 10px; }
    .step-section.active { display: block; opacity: 1; animation: fadeIn 0.6s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .loading-box { text-align: center; padding: 30px; color: var(--c-gold); display: none; background: var(--c-gold-light); border-radius: 8px; margin-top: 20px; }
    .footer { text-align: center; color: #999; font-size: 0.8rem; padding: 40px 0; margin-top: auto; }

    div:where(.swal2-container) h2:where(.swal2-title) { font-family: var(--font-serif) !important; color: var(--c-dark) !important; }
    div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: var(--c-gold) !important; box-shadow: 0 4px 15px rgba(191, 161, 95, 0.4) !important; }

    @media (max-width: 768px) {
        .container { margin-top: -30px; }
        .inquiry-card { padding: 30px 20px; }
        .venue-grid { grid-template-columns: 1fr; }
        .header-section h1 { font-size: 1.5rem; }
    }
</style>
</head>
<body>

    <div id="auto-send-overlay">
        <i class="fa-solid fa-paper-plane fa-3x" style="color:var(--c-gold); margin-bottom:20px;"></i>
        <h2 style="color:var(--c-dark); margin:0;">æ­£åœ¨å‚³é€è©¢åƒ¹å–®...</h2>
        <p style="color:#888;">ç³»çµ±æ­£åœ¨è™•ç†æ‚¨çš„éœ€æ±‚ï¼Œè«‹ç¨å€™</p>
    </div>

    <nav class="navbar"><a href="#" class="nav-logo">ä½ å¥½å“‡å¯“æ‰€ | æºé ‚æ°‘å®¿</a></nav>
    <div class="header-section"><h1>æˆ¿æ³æŸ¥è©¢èˆ‡å ±åƒ¹</h1><p>Check Availability & Price</p></div>

    <div class="container" id="main-content">
        <div class="inquiry-card">
            
            <div id="step-1">
                <div class="section-title">
                    <span>01. æŸ¥è©¢æª”æœŸ</span>
                    <i class="fa-regular fa-calendar" style="color:var(--c-gold)"></i>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å…¥ä½ - é€€æˆ¿æ—¥æœŸ</label>
                    <input type="text" id="date-range" class="form-input readonly" placeholder="è«‹é»æ“Šé¸æ“‡æ—¥æœŸ..." readonly>
                </div>
                
                <button class="btn-submit btn-search" onclick="startQuery()">
                    <span>æŸ¥è©¢å³æ™‚æˆ¿æ³</span> <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                
                <div id="loading-box" class="loading-box">
                    <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
                    <div style="margin-top:10px; font-weight:bold;">ç³»çµ±æ­£åœ¨ç¢ºèªå³æ™‚æˆ¿æ³...</div>
                </div>

                <div id="venue-results" class="venue-grid" style="display:none;"></div>
                <div id="recommendation-area" class="recommendation-box"></div>
            </div>

            <div id="step-2" class="step-section">
                <div class="section-title">
                    <span>02. é¸æ“‡åŒ…æ£Ÿæ–¹æ¡ˆ</span>
                    <i class="fa-solid fa-hotel" style="color:var(--c-gold)"></i>
                </div>
                <div id="plan-container" class="plan-grid"></div>
                <div style="text-align:right; font-size:0.8rem; color:#999; margin-top:10px;">* åƒ¹æ ¼ç‚ºç³»çµ±ä¾å¹³å‡æ—¥é ä¼°ï¼Œå¯¦éš›é‡‘é¡ä»¥ç®¡å®¶æœ€çµ‚å ±åƒ¹ç‚ºæº–</div>
            </div>

            <div id="step-3" class="step-section">
                <div class="section-title">
                    <span>03. ç²å–å„ªæƒ å ±åƒ¹</span>
                    <i class="fa-solid fa-pen-nib" style="color:var(--c-gold)"></i>
                </div>
                
                <div style="background: #FAFAFA; padding: 25px; border-radius: 8px; border: 1px solid #EEE;">
                    <div class="form-group">
                        <label class="form-label">æ‚¨çš„ç¨±å‘¼ (Name)</label>
                        <input type="text" id="user-name" class="form-input" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯çµ¡é›»è©± (Phone)</label>
                        <input type="tel" id="user-phone" class="form-input" placeholder="09xxxxxxxx" maxlength="10">
                    </div>
                    
                    <button id="btn-submit" class="btn-submit" onclick="handleSend()">
                        <span>å‚³é€è©¢åƒ¹å–®çµ¦ç®¡å®¶</span> <i class="fa-brands fa-line" style="font-size:1.2rem;"></i>
                    </button>
                    
                    <p style="text-align:center; font-size:0.85rem; color:#999; margin-top:15px;">
                        <i class="fa-solid fa-shield-halved"></i> é›»è…¦ç‰ˆå°‡è‡ªå‹•ç”Ÿæˆ QR Code ä¾›æ‰‹æ©Ÿæƒæ
                    </p>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">Â© 2025 ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿. All Rights Reserved.</footer>

    <script>
        // --- è¨­å®šå€ ---
        const LIFF_ID = "2008582194-wrJ4dqXq"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxsFEJ9ubWMY9Y6xqBZ-3-KgSrYQnC9D3zwuKUL66HvKJdN5S1HTNeahhWlV6hcixbx0A/exec";
        
        // --- æˆ¿å‹èˆ‡å®šåƒ¹è³‡æ–™åº« ---
        const ROOM_PLANS = {
            'hello': [
                { title: "3æˆ¿åŒ…æ£Ÿ (8äºº)", price_weekday: 16000, price_weekend: 20000, capacity: "8äºº", detail: "é…ç½®ï¼š3æˆ¿ (2/2/4)" },
                { title: "4æˆ¿åŒ…æ£Ÿ (14äºº)", price_weekday: 20000, price_weekend: 24000, capacity: "14äºº", detail: "é…ç½®ï¼š4æˆ¿ (2/2/4/6)" },
                { title: "5æˆ¿åŒ…æ£Ÿ (16äºº)", price_weekday: 22000, price_weekend: 26000, capacity: "16äºº", detail: "é…ç½®ï¼š5æˆ¿ (2/2/2/4/6)" },
                { title: "5+1æˆ¿åŒ…æ£Ÿ (22äºº)", price_weekday: 26000, price_weekend: 30000, capacity: "22äºº", detail: "é…ç½®ï¼š5+1æˆ¿ (2/2/2/4/6/6)" },
                { title: "5+1æˆ¿+åŠ åºŠ (26äºº)", price_weekday: 30000, price_weekend: 36000, capacity: "26äºº", detail: "é…ç½®ï¼šå…¨æ£ŸåŠ åºŠä½¿ç”¨" }
            ],
            'gouding': [
                { title: "3æˆ¿åŒ…æ£Ÿ (10äºº)", price_weekday: 10000, price_weekend: 14000, capacity: "10äºº", detail: "é…ç½®ï¼š3æˆ¿ (2/4/4)" },
                { title: "4æˆ¿åŒ…æ£Ÿ (12äºº)", price_weekday: 12000, price_weekend: 16000, capacity: "12äºº", detail: "é…ç½®ï¼š4æˆ¿ (2/4/4/2)" }
            ]
        };

        let selectedStart, selectedEnd;
        let currentVenue = "", currentPlan = "", currentPrice = "";

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. å…ˆæª¢æŸ¥æ˜¯ä¸æ˜¯æƒæ QR Code é€²ä¾†çš„ (å¦‚æœæœ‰ auto=yes)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auto') === 'yes') {
                // æ˜¯æƒæé€²ä¾†çš„ -> å•Ÿå‹•éš±å½¢æ¨¡å¼
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('auto-send-overlay').style.display = 'flex';
                
                // é‚„åŸè³‡æ–™
                selectedStart = new Date(urlParams.get('start'));
                selectedEnd = new Date(urlParams.get('end'));
                currentVenue = urlParams.get('venue');
                currentPlan = urlParams.get('plan');
                currentPrice = urlParams.get('price');
                const name = urlParams.get('name');
                const phone = urlParams.get('phone');

                // åˆå§‹åŒ– LIFF ä¸¦åŸ·è¡Œè‡ªå‹•ç™¼é€
                liff.init({ liffId: LIFF_ID }).then(() => {
                    if(!liff.isLoggedIn()) {
                        liff.login(); // å¼·åˆ¶ç™»å…¥æ‰èƒ½ç™¼é€
                    } else {
                        // å»¶é² 1 ç§’ç™¼é€ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°è™•ç†ä¸­
                        setTimeout(() => { sendFlexMessage(name, phone); }, 1000);
                    }
                });
                return; // çµ‚æ­¢å¾ŒçºŒåˆå§‹åŒ–ï¼Œå°ˆæ³¨æ–¼è‡ªå‹•ç™¼é€
            }

            // 2. æ­£å¸¸ç€è¦½æ¨¡å¼
            flatpickr("#date-range", {
                mode: "range", locale: "zh_tw", dateFormat: "Y-m-d", minDate: "today",
                onClose: (dates) => {
                    if (dates.length === 2) {
                        selectedStart = dates[0];
                        selectedEnd = dates[1];
                        document.getElementById('step-2').classList.remove('active');
                        document.getElementById('step-3').classList.remove('active');
                        document.getElementById('venue-results').style.display = 'none';
                        document.getElementById('recommendation-area').style.display = 'none';
                    }
                }
            });
            
            liff.init({ liffId: LIFF_ID }).then(() => console.log("LIFF Ready"));
        });

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function startQuery() {
            if (!selectedStart || !selectedEnd) { Swal.fire({icon:'warning', title:'è«‹å…ˆé¸æ“‡æ—¥æœŸ', confirmButtonColor:'#BFA15F'}); return; }
            
            const loadBox = document.getElementById('loading-box');
            loadBox.style.display = 'block';
            document.getElementById('venue-results').style.display = 'none';
            document.getElementById('recommendation-area').style.display = 'none';
            document.getElementById('step-2').classList.remove('active');
            
            const startStr = formatDate(selectedStart);
            const endStr = formatDate(selectedEnd);

            fetch(`${GAS_URL}?start=${startStr}&end=${endStr}`)
            .then(res => res.json())
            .then(data => {
                loadBox.style.display = 'none';
                renderVenues(data.status);
                if (data.suggestions && data.suggestions.length > 0) {
                    renderRecommendations(data.suggestions);
                }
            })
            .catch(err => {
                console.error(err);
                loadBox.style.display = 'none';
                Swal.fire({icon:'error', title:'é€£ç·šéŒ¯èª¤', text: 'è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦', confirmButtonColor:'#2C3E50'});
            });
        }

        function renderVenues(status) {
            const container = document.getElementById('venue-results');
            container.style.display = 'grid';
            container.innerHTML = '';

            const venues = [
                { key: 'hello', name: 'ä½ å¥½å“‡å¯“æ‰€ (ä¸»é¤¨)', available: status.hello.available, sub: 'Hello House' },
                { key: 'gouding', name: 'æºé ‚æ°‘å®¿ (äºŒé¤¨)', available: status.gouding.available, sub: 'Godin House' }
            ];

            venues.forEach(v => {
                const div = document.createElement('div');
                div.className = `venue-card ${v.available ? 'available' : 'disabled'}`;
                const icon = v.available ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-xmark"></i>';
                const statusText = v.available ? 'ç«‹å³é è¨‚' : 'å·²æ»¿æˆ¿';
                
                div.innerHTML = `
                    <h4>${v.name}</h4>
                    <span>${v.sub}</span>
                    <div class="status-badge">${icon} ${statusText}</div>
                `;
                if(v.available) {
                    div.onclick = () => showPlans(v.key, v.name);
                }
                container.appendChild(div);
            });
        }

        function renderRecommendations(list) {
            const box = document.getElementById('recommendation-area');
            box.style.display = 'block';
            let html = `<div class="rec-title"><i class="fa-solid fa-bell"></i> æœ¬æª”æœŸå·²æ»¿ï¼Œç‚ºæ‚¨æ¨è–¦ï¼š</div>`;
            list.forEach(item => {
                const tagClass = item.tag === 'part' ? 'rec-tag part' : 'rec-tag';
                const tagName = item.tag === 'part' ? 'ç¸®çŸ­å¤©æ•¸' : 'æ¨è–¦ç©ºæª”';
                html += `
                    <div class="rec-item" onclick="applyDate('${item.start}', '${item.end}')">
                        <div>
                            <span class="${tagClass}">${tagName}</span>
                            <span style="font-weight:bold; color:#555;">${item.start} ~ ${item.end}</span>
                            <span style="font-size:0.8rem; color:#888;">(${item.label})</span>
                        </div>
                        <i class="fa-solid fa-angle-right" style="color:#CCC;"></i>
                    </div>
                `;
            });
            box.innerHTML = html;
        }

        function applyDate(s, e) {
            const fp = document.querySelector("#date-range")._flatpickr;
            fp.setDate([s, e]);
            selectedStart = new Date(s);
            selectedEnd = new Date(e);
            startQuery(); 
        }

        function showPlans(key, name) {
            currentVenue = name;
            document.querySelectorAll('.venue-card').forEach(el => el.style.opacity = '0.5');
            event.currentTarget.style.opacity = '1';
            event.currentTarget.style.borderColor = 'var(--c-gold)';

            const container = document.getElementById('plan-container');
            container.innerHTML = '';
            
            const plans = ROOM_PLANS[key] || [];
            const calc = calculatePrice(selectedStart, selectedEnd);

            plans.forEach(p => {
                const total = (calc.weekdays * p.price_weekday) + (calc.weekends * p.price_weekend);
                const avgPrice = Math.round(total / (calc.weekdays + calc.weekends));
                
                const div = document.createElement('div');
                div.className = 'plan-card';
                div.innerHTML = `
                    <span class="plan-capacity">${p.capacity}</span>
                    <div class="plan-title">${p.title}</div>
                    <div class="plan-detail">${p.detail}</div>
                    <div class="plan-price">
                        $${total.toLocaleString()} 
                        <small>(${calc.weekdays}å¹³æ—¥+${calc.weekends}å‡æ—¥)</small>
                    </div>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.plan-card').forEach(e => e.classList.remove('selected'));
                    div.classList.add('selected');
                    currentPlan = p.title;
                    currentPrice = `$${total.toLocaleString()}`;
                    const step3 = document.getElementById('step-3');
                    step3.classList.add('active');
                    setTimeout(() => step3.scrollIntoView({ behavior: 'smooth', block: 'start' }), 300);
                };
                container.appendChild(div);
            });
            
            const step2 = document.getElementById('step-2');
            step2.classList.add('active');
            step2.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function calculatePrice(start, end) {
            let weekdays = 0;
            let weekends = 0;
            let cur = new Date(start);
            const stop = new Date(end);
            
            while(cur < stop) {
                const day = cur.getDay();
                if (day === 5 || day === 6) weekends++; else weekdays++;
                cur.setDate(cur.getDate() + 1);
            }
            return { weekdays, weekends };
        }

        // --- ç™¼é€æ§åˆ¶ä¸­å¿ƒ ---
        // --- ç™¼é€æ§åˆ¶ä¸­å¿ƒ (ä¿®æ­£æ‰‹æ©Ÿç€è¦½å™¨å•é¡Œ) ---
        function handleSend() {
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();

            if(!name || !phone) { Swal.fire({ icon: 'warning', title: 'è³‡æ–™ä¸å®Œæ•´', text: 'è«‹è¼¸å…¥å§“åèˆ‡é›»è©±', confirmButtonColor: '#BFA15F' }); return; }

            // æº–å‚™è³‡æ–™åƒæ•¸
            const params = new URLSearchParams({
                start: formatDate(selectedStart),
                end: formatDate(selectedEnd),
                venue: currentVenue,
                plan: currentPlan,
                price: currentPrice,
                name: name,
                phone: phone,
                auto: "yes"
            });
            const liffUrl = `https://liff.line.me/${LIFF_ID}?${params.toString()}`;

            // æƒ…æ³ 1: å·²ç¶“åœ¨ LINE App å…§ -> ç›´æ¥ç™¼é€
            if (liff.isInClient()) {
                autoParams = {
                    sDate: formatDate(selectedStart),
                    eDate: formatDate(selectedEnd),
                    venue: currentVenue,
                    plan: currentPlan,
                    price: currentPrice,
                    name: name,
                    phone: phone
                };
                forceSend();
            } 
            // æƒ…æ³ 2: åœ¨æ‰‹æ©Ÿç€è¦½å™¨ (Chrome/Safari) -> è·³è½‰å–šé†’ LINE App
            else if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // é¡¯ç¤ºè·³è½‰æç¤ºï¼Œæå‡é«”é©—
                Swal.fire({
                    title: 'æ­£åœ¨é–‹å•Ÿ LINE...',
                    text: 'å°‡ç‚ºæ‚¨è‡ªå‹•å¸¶å…¥è³‡æ–™ä¸¦å‚³é€',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                });
                
                // å»¶é²ä¸€é»é»è®“ä½¿ç”¨è€…çœ‹åˆ°æç¤ºï¼Œç„¶å¾Œè·³è½‰
                setTimeout(() => {
                    window.location.href = liffUrl;
                }, 800);
            } 
            // æƒ…æ³ 3: é›»è…¦ç‰ˆ -> é¡¯ç¤º QR Code
            else {
                generateLiffQrCode(liffUrl);
            }
        }

        // ä¿®æ”¹å¾Œçš„ QR Code å‡½å¼ (é…åˆä¸Šé¢çš„é‚è¼¯)
        function generateLiffQrCode(url) {
            Swal.fire({
                title: 'ğŸ“± è«‹ç”¨æ‰‹æ©Ÿæƒæå‚³é€',
                html: `
                    <div style="font-size:0.9rem; color:#666; margin-bottom:20px;">
                        è«‹é–‹å•Ÿæ‰‹æ©Ÿ LINE æƒæä¸‹æ–¹ QR Code<br>å³å¯å¿«é€Ÿç™¼é€è©¢åƒ¹å–®çµ¦ç®¡å®¶
                    </div>
                    <div id="qrcode" style="display:flex; justify-content:center; margin:10px auto;"></div>
                `,
                showConfirmButton: false, 
                showCloseButton: true,
                width: 400,
                didOpen: () => {
                    new QRCode(document.getElementById("qrcode"), {
                        text: url, width: 200, height: 200, colorDark : "#2C3E50", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M
                    });
                }
            });
        }

        // é›»è…¦ç‰ˆï¼šç”Ÿæˆ "è‡ªå‹•ç™¼é€æ¨¡å¼" çš„ QR Code
        function generateLiffQrCode(name, phone) {
            // é€™è£¡å°‡æ‰€æœ‰è³‡æ–™æ‰“åŒ…é€² URLï¼Œä¸¦åŠ ä¸Š auto=yes
            const params = new URLSearchParams({
                start: formatDate(selectedStart),
                end: formatDate(selectedEnd),
                venue: currentVenue,
                plan: currentPlan,
                price: currentPrice,
                name: name,
                phone: phone,
                auto: "yes" // é—œéµåƒæ•¸
            });
            
            // æ‰‹æ©Ÿæƒæå¾Œæœƒé–‹å•Ÿé€™å€‹ç¶²å€
            const liffUrl = `https://liff.line.me/${LIFF_ID}?${params.toString()}`;
            
            Swal.fire({
                title: 'ğŸ“± è«‹ç”¨æ‰‹æ©Ÿæƒæå‚³é€',
                html: `
                    <div style="font-size:0.9rem; color:#666; margin-bottom:20px;">
                        è«‹é–‹å•Ÿæ‰‹æ©Ÿ LINE æƒæä¸‹æ–¹ QR Code<br>å³å¯å¿«é€Ÿç™¼é€è©¢åƒ¹å–®çµ¦ç®¡å®¶
                    </div>
                    <div id="qrcode" style="display:flex; justify-content:center; margin:10px auto;"></div>
                `,
                showConfirmButton: false, 
                showCloseButton: true,
                width: 400,
                didOpen: () => {
                    new QRCode(document.getElementById("qrcode"), {
                        text: liffUrl, width: 200, height: 200, colorDark : "#2C3E50", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M
                    });
                }
            });
        }

        // åŸ·è¡Œç™¼é€ Flex Message
        // --- æœ€çµ‚ç™¼é€å‡½å¼ (å«å¤±æ•—è‡ªå‹•æ•‘æ´) ---
        function sendFlexMessage(name, phone) {
            const btn = document.getElementById('btn-submit');
            if(btn) { btn.disabled = true; btn.innerHTML = '<span>å‚³é€ä¸­...</span> <i class="fa-solid fa-spinner fa-spin"></i>'; }
            
            // æº–å‚™ Flex Message (ç²¾ç¾å°å¡)
            const flexMessage = {
                "type": "flex", "altText": "ğŸ“‹ ä¾†è‡ªç¶²ç«™çš„è¨‚æˆ¿è©¢åƒ¹å–®",
                "contents": {
                    "type": "bubble", "size": "mega",
                    "header": {
                        "type": "box", "layout": "vertical", "backgroundColor": "#2C3E50", "paddingAll": "lg",
                        "contents": [
                            { "type": "text", "text": "è¨‚æˆ¿è©¢åƒ¹å–®", "color": "#BFA15F", "weight": "bold", "size": "xl" },
                            { "type": "text", "text": "BOOKING INQUIRY", "color": "#95A5A6", "size": "xs", "margin": "sm", "letterSpacing": "1px" }
                        ]
                    },
                    "body": {
                        "type": "box", "layout": "vertical", "paddingAll": "lg",
                        "contents": [
                            { "type": "text", "text": "å®¢æˆ¶è©¢åƒ¹å…§å®¹ï¼š", "size": "sm", "color": "#888888", "margin": "md" },
                            { "type": "separator", "margin": "lg" },
                            {
                                "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm",
                                "contents": [
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“… æ—¥æœŸ", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": `${formatDate(selectedStart)} ~ ${formatDate(selectedEnd)}`, "wrap": true, "color": "#333333", "size": "sm", "flex": 5 }] },
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ¨ é¤¨åˆ¥", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": currentVenue, "wrap": true, "color": "#333333", "size": "sm", "flex": 5, "weight": "bold" }] },
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ›ï¸ æ–¹æ¡ˆ", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": currentPlan, "wrap": true, "color": "#333333", "size": "sm", "flex": 5 }] },
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ’° é ç®—", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": currentPrice, "wrap": true, "color": "#BFA15F", "size": "sm", "flex": 5, "weight": "bold" }] },
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ‘¤ å§“å", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": name, "wrap": true, "color": "#333333", "size": "sm", "flex": 5 }] },
                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“± é›»è©±", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": phone, "wrap": true, "color": "#333333", "size": "sm", "flex": 5 }] }
                                ]
                            },
                            { "type": "separator", "margin": "xl" },
                            { "type": "text", "text": "è«‹ç®¡å®¶å”åŠ©ç¢ºèªä¸¦å›è¦†", "size": "xs", "color": "#BFA15F", "margin": "lg", "align": "center" }
                        ]
                    }
                }
            };

            // å˜—è©¦ç™¼é€
            liff.sendMessages([flexMessage])
                .then(() => { 
                    liff.closeWindow(); // æˆåŠŸï¼šé—œé–‰è¦–çª—
                })
                .catch((err) => {
                    console.error("LIFF Send Failed:", err);
                    
                    // â˜…â˜…â˜… è‡ªå‹•è£œæ•‘æ©Ÿåˆ¶ â˜…â˜…â˜…
                    // å¦‚æœ sendMessages å¤±æ•— (ä¾‹å¦‚æ²’åŠ å¥½å‹ã€æ¬Šé™ä¸è¶³)ï¼Œ
                    // å‰‡æ”¹ç”¨ "è·³è½‰èŠå¤©å®¤ä¸¦å¸¶å…¥æ–‡å­—" çš„æ–¹å¼ (ä¿è­‰ 100% èƒ½é€å‡º)
                    
                    const textMsg = `ä½ å¥½ï¼æˆ‘æƒ³è©¢å•è¨‚æˆ¿ ğŸ’°\n--------------------------\nğŸ“… æ—¥æœŸï¼š${formatDate(selectedStart)} ~ ${formatDate(selectedEnd)}\nğŸ¨ é¤¨åˆ¥ï¼š${currentVenue}\nğŸ›ï¸ æ–¹æ¡ˆï¼š${currentPlan}\nğŸ’° ç³»çµ±ç®—åƒ¹ï¼š${currentPrice}\n--------------------------\nğŸ‘¤ å§“åï¼š${name}\nğŸ“± é›»è©±ï¼š${phone}\n--------------------------\nè«‹å•æ˜¯å¦æœ‰ç©ºæˆ¿ï¼Ÿè¬è¬ï¼`;
                    
                    // è·³è½‰åˆ°å®˜æ–¹å¸³è™ŸèŠå¤©å®¤ï¼Œä¸¦å¡«å¥½æ–‡å­—
                    window.location.href = `https://line.me/R/oaMessage/${LINE_OFFICIAL_ID}/?text=${encodeURIComponent(textMsg)}`;
                    
                    // æ¢å¾©æŒ‰éˆ•
                    if(btn) { btn.disabled = false; btn.innerText = "å‚³é€è©¢åƒ¹å–®çµ¦ç®¡å®¶"; }
                });
        }

        function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    </script>
</body>
</html>