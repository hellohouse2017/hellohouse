<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å³æ™‚æˆ¿æ³èˆ‡å ±åƒ¹ | ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* --- é«˜ç´šé…è‰²ç³»çµ± --- */
        :root { 
            --c-dark: #2C3E50; --c-gold: #BFA15F; --c-gold-light: #F9F5EB; 
            --c-red: #A94442; --c-gray: #7F8C8D; --c-white: #FFFFFF; 
            --font-serif: 'Noto Serif TC', serif; --font-sans: 'Noto Sans TC', sans-serif; 
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.06); 
        }
        *, *::before, *::after { box-sizing: border-box; }
        
        body { margin: 0; font-family: var(--font-sans); background-color: #F5F5F5; color: var(--c-dark); line-height: 1.7; display: flex; flex-direction: column; min-height: 100vh; padding-top: 60px; }

        #auto-send-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }

        .navbar { background: var(--c-dark); height: 60px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; width: 100%; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-logo { color: var(--c-gold); font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-decoration: none; }

        .header-section { padding: 40px 20px; text-align: center; background: var(--c-dark); color: white; margin-bottom: 30px; }
        .header-section h1 { margin: 0; font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 3px; font-weight: 500; }
        .header-section p { margin: 5px 0 0; font-size: 0.8rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 2px; }

        .container { width: 95%; max-width: 800px; margin: -50px auto 40px; position: relative; z-index: 10; }
        .inquiry-card { background-color: var(--c-white); padding: 40px; border-radius: 4px; box-shadow: var(--shadow-card); border-top: 6px solid var(--c-gold); }

        .section-title { font-family: var(--font-serif); font-size: 1.2rem; color: var(--c-dark); margin: 30px 0 20px; padding-left: 15px; border-left: 4px solid var(--c-gold); display: flex; align-items: center; justify-content: space-between; }
        
        .guest-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .guest-btn { padding: 15px 5px; border: 1px solid #DDD; border-radius: 6px; background: #FAFAFA; cursor: pointer; transition: 0.3s; text-align: center; position: relative; }
        .guest-btn:hover { background: #F0F0F0; border-color: var(--c-gold); }
        .guest-btn.active { border: 2px solid var(--c-gold); background: var(--c-gold-light); color: var(--c-dark); box-shadow: 0 4px 10px rgba(191, 161, 95, 0.2); }
        .guest-btn.active::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -8px; right: -8px; background: var(--c-gold); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }
        .guest-btn h4 { margin: 0; font-size: 0.95rem; font-weight: bold; font-family: var(--font-serif); }
        .guest-btn span { font-size: 0.75rem; color: #888; display: block; margin-top: 4px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.85rem; color: var(--c-gray); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 12px; font-size: 1rem; color: var(--c-dark); font-family: var(--font-serif); border: 1px solid #DDD; border-radius: 4px; background: #FAFAFA; transition: 0.3s; }
        .form-input:focus { outline: none; border-color: var(--c-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1); }
        .form-input.readonly { background: #fff; cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23BFA15F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>'); background-repeat: no-repeat; background-position: right 15px center; }

        .btn-submit { background-color: var(--c-dark); color: var(--c-gold); border: 1px solid var(--c-dark); padding: 15px 40px; font-size: 1rem; font-weight: bold; letter-spacing: 1px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .btn-submit:hover { background-color: var(--c-gold); color: white; border-color: var(--c-gold); transform: translateY(-2px); }
        .btn-submit:disabled { background-color: #BDC3C7; border-color: #BDC3C7; color: white; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-search { background-color: var(--c-gold); color: white; border-color: var(--c-gold); }
        .btn-search:hover { background-color: #A68550; border-color: #A68550; }

        .venue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .venue-card { padding: 15px; border: 1px solid #DDD; border-radius: 6px; background: #FAFAFA; cursor: pointer; transition: 0.3s; text-align: center; position: relative; display: flex; flex-direction: column; justify-content: space-between;}
        .venue-card h4 { margin: 0; font-size: 1rem; color: var(--c-dark); font-weight: bold; font-family: var(--font-serif); }
        .venue-card span { font-size: 0.8rem; color: #999; display: block; margin-top: 5px; }
        .venue-card.available { border-color: var(--c-gold); background: #FFF; }
        .venue-card.available:hover { background: var(--c-gold-light); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(191, 161, 95, 0.15); }
        .venue-card.available .status-badge { color: var(--c-gold); font-weight: bold; font-size: 0.8rem; margin-top: 5px; }
        .venue-card.disabled { opacity: 0.6; cursor: not-allowed; background: #EEE; border-style: dashed; }
        .venue-card.disabled .status-badge { color: var(--c-red); margin-top: 5px; font-size: 0.8rem; font-weight: bold; }

        .recommendation-box { margin-top: 25px; border: 1px dashed #A68550; background: #FFFCF5; padding: 20px; border-radius: 6px; display: none; animation: fadeIn 0.5s; }
        .rec-title { font-size: 0.95rem; color: #A68550; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px dashed #E0D6C3; padding-bottom: 8px;}
        .rec-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #EED; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .rec-item:hover { border-color: var(--c-gold); transform: translateX(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rec-tag { background: #E74C3C; color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 3px; margin-right: 8px; font-weight: bold; }
        .rec-tag.part { background: #F39C12; }

        .plan-grid { display: grid; gap: 15px; }
        .plan-card { border: 1px solid #DDD; background-color: #FFF; padding: 20px; border-radius: 6px; position: relative; cursor: pointer; transition: 0.3s; }
        .plan-card:hover { border-color: var(--c-gold); background: #FFFCF5; }
        .plan-card.selected { border: 2px solid var(--c-gold); background-color: var(--c-gold-light); box-shadow: 0 4px 15px rgba(191, 161, 95, 0.2); }
        .plan-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -10px; right: -5px; background: var(--c-gold); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
        .plan-capacity { position: absolute; top: 15px; right: 15px; background: #EDF2F7; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; color: #555; font-weight: bold; }
        .plan-title { font-weight: bold; color: var(--c-dark); font-size: 1.1rem; font-family: var(--font-serif); margin-bottom: 5px; }
        .plan-detail { font-size: 0.85rem; color: #7F8C8D; margin-bottom: 10px; border-top: 1px solid #EEE; padding-top: 8px; margin-top: 8px; }
        .plan-price { font-size: 1.1rem; color: var(--c-gold); font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .plan-price small { font-size: 0.75rem; color: #999; font-weight: normal; }

        .step-section { display: none; opacity: 0; transition: opacity 0.5s ease; border-top: 1px dashed #EEE; margin-top: 30px; padding-top: 10px; }
        .step-section.active { display: block; opacity: 1; animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .loading-box { text-align: center; padding: 30px; color: var(--c-gold); display: none; background: var(--c-gold-light); border-radius: 8px; margin-top: 20px; }
        .footer { text-align: center; color: #999; font-size: 0.8rem; padding: 40px 0; margin-top: auto; }

        div:where(.swal2-container) h2:where(.swal2-title) { font-family: var(--font-serif) !important; color: var(--c-dark) !important; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: var(--c-gold) !important; box-shadow: 0 4px 15px rgba(191, 161, 95, 0.4) !important; }

        @media (max-width: 768px) {
            .container { margin-top: -30px; }
            .inquiry-card { padding: 30px 20px; }
            .venue-grid { grid-template-columns: 1fr; }
            .header-section h1 { font-size: 1.5rem; }
            .guest-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="auto-send-overlay">
        <div style="max-width:300px; margin:0 auto;">
            <i class="fa-solid fa-paper-plane fa-3x fa-beat" style="color:var(--c-gold); margin-bottom:20px; --fa-animation-duration: 2s;"></i>
            <h2 style="color:var(--c-dark); margin:0 0 10px 0; font-family:var(--font-serif);">æ­£åœ¨å‚³é€è©¢åƒ¹å–®...</h2>
            <p style="color:#888; font-size:0.9rem;">ç³»çµ±æ­£åœ¨è™•ç†æ‚¨çš„éœ€æ±‚ï¼Œè«‹ç¨å€™</p>
            <button id="manual-send-btn" class="btn-submit" style="display:none; margin-top:20px; font-size:0.9rem; padding:10px 20px;" onclick="forceSend()">é»æ­¤æ‰‹å‹•ç™¼é€</button>
        </div>
    </div>

    <nav class="navbar"><a href="#" class="nav-logo">ä½ å¥½å“‡å¯“æ‰€ | æºé ‚æ°‘å®¿</a></nav>
    <div class="header-section"><h1>æˆ¿æ³æŸ¥è©¢èˆ‡å ±åƒ¹</h1><p>Check Availability & Price</p></div>

    <div class="container" id="main-content">
        <div class="inquiry-card">
            
            <div id="step-1">
                <div class="section-title">
                    <span>01. é è¨ˆå…¥ä½äººæ•¸</span>
                    <i class="fa-solid fa-users" style="color:var(--c-gold)"></i>
                </div>
                <div class="guest-grid">
                    <div class="guest-btn" onclick="selectGuestRange('small', this)"><h4>6 - 12 äºº</h4><span>ä½ å¥½å“‡ / æºé ‚çš†å¯</span></div>
                    <div class="guest-btn" onclick="selectGuestRange('medium', this)"><h4>13 - 26 äºº</h4><span>ä½ å¥½å“‡å¯“æ‰€</span></div>
                    <div class="guest-btn" onclick="selectGuestRange('large', this)"><h4>27 - 38 äºº</h4><span>é›™é¤¨åŒ…æ£Ÿ (è¯è³£)</span></div>
                </div>
            </div>

            <div id="step-2" class="step-section">
                <div class="section-title">
                    <span>02. æŸ¥è©¢æª”æœŸ</span>
                    <i class="fa-regular fa-calendar" style="color:var(--c-gold)"></i>
                </div>
                <div class="form-group">
                    <label class="form-label">å…¥ä½ - é€€æˆ¿æ—¥æœŸ</label>
                    <input type="text" id="date-range" class="form-input readonly" placeholder="è«‹é»æ“Šé¸æ“‡æ—¥æœŸ..." readonly>
                </div>
                <button class="btn-submit btn-search" onclick="startQuery()"><span>æŸ¥è©¢å³æ™‚æˆ¿æ³</span> <i class="fa-solid fa-magnifying-glass"></i></button>
                <div id="loading-box" class="loading-box"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><div style="margin-top:10px; font-weight:bold;">ç³»çµ±æ­£åœ¨ç¢ºèªå³æ™‚æˆ¿æ³...</div></div>
                <div id="venue-results" class="venue-grid" style="display:none;"></div>
                <div id="recommendation-area" class="recommendation-box"></div>
            </div>

            <div id="step-3" class="step-section">
                <div class="section-title">
                    <span>03. é¸æ“‡æ–¹æ¡ˆ</span>
                    <i class="fa-solid fa-hotel" style="color:var(--c-gold)"></i>
                </div>
                <div id="plan-container" class="plan-grid"></div>
                <div style="text-align:right; font-size:0.8rem; color:#999; margin-top:10px;">* åƒ¹æ ¼ç‚ºç³»çµ±ä¾å¹³å‡æ—¥é ä¼°ï¼Œå¯¦éš›é‡‘é¡ä»¥ç®¡å®¶æœ€çµ‚å ±åƒ¹ç‚ºæº–</div>
            </div>

            <div id="step-4" class="step-section">
                <div class="section-title">
                    <span>04. ç²å–å„ªæƒ å ±åƒ¹</span>
                    <i class="fa-solid fa-pen-nib" style="color:var(--c-gold)"></i>
                </div>
                <div style="background: #FAFAFA; padding: 25px; border-radius: 8px; border: 1px solid #EEE;">
                    <div class="form-group"><label class="form-label">æ‚¨çš„ç¨±å‘¼ (Name)</label><input type="text" id="user-name" class="form-input" placeholder="è«‹è¼¸å…¥å§“å"></div>
                    <div class="form-group"><label class="form-label">è¯çµ¡é›»è©± (Phone)</label><input type="tel" id="user-phone" class="form-input" placeholder="09xxxxxxxx" maxlength="10"></div>
                    <button id="btn-submit" class="btn-submit" onclick="handleSend()"><span>å‚³é€è©¢åƒ¹å–®çµ¦ç®¡å®¶</span> <i class="fa-brands fa-line" style="font-size:1.2rem;"></i></button>
                    <p style="text-align:center; font-size:0.85rem; color:#999; margin-top:15px;"><i class="fa-solid fa-shield-halved"></i> é›»è…¦ç‰ˆå°‡è‡ªå‹•ç”Ÿæˆ QR Code ä¾›æ‰‹æ©Ÿæƒæ</p>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">Â© 2025 ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿. All Rights Reserved.</footer>

    <script>
        // ============================================
        // âš ï¸ è«‹ä¿®æ”¹ä»¥ä¸‹ 3 å€‹è®Šæ•¸ç‚ºæ‚¨è‡ªå·±çš„è¨­å®š
        // ============================================
        const LIFF_ID = "2008582194-wrJ4dqXq"; // æ‚¨çš„ LIFF ID
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzfqpbILo5s6P0593PcdpYVie5cbyYGhxe83-Xbzs5QHymN6uNwo37ziT0As6zj1tZk1w/exec"; // æ‚¨çš„ GAS ç¶²å€
        //const GAS_URL = "https://script.google.com/macros/s/AKfycbxsFEJ9ubWMY9Y6xqBZ-3-KgSrYQnC9D3zwuKUL66HvKJdN5S1HTNeahhWlV6hcixbx0A/exec"; // æ‚¨çš„ GAS ç¶²å€
        const LINE_OFFICIAL_ID = "@575tprig"; // æ‚¨çš„ LINE å®˜æ–¹å¸³è™Ÿ ID (å«@)
        // ============================================
        const RULES_URL = "agreement.html"; 
        
        const ROOM_PLANS = {
            'hello': [
                { title: "3æˆ¿åŒ…æ£Ÿ (8äºº)", price_weekday: 16000, price_weekend: 20000, capacity: "8äºº", detail: "é…ç½®ï¼š3æˆ¿ (2/2/4)" },
                { title: "4æˆ¿åŒ…æ£Ÿ (14äºº)", price_weekday: 20000, price_weekend: 24000, capacity: "14äºº", detail: "é…ç½®ï¼š4æˆ¿ (2/2/4/6)" },
                { title: "5æˆ¿åŒ…æ£Ÿ (16äºº)", price_weekday: 22000, price_weekend: 26000, capacity: "16äºº", detail: "é…ç½®ï¼š5æˆ¿ (2/2/2/4/6)" },
                { title: "5+1æˆ¿åŒ…æ£Ÿ (22äºº)", price_weekday: 26000, price_weekend: 30000, capacity: "22äºº", detail: "é…ç½®ï¼š5+1æˆ¿ (2/2/2/4/6/6)" },
                { title: "5+1æˆ¿+åŠ åºŠ (26äºº)", price_weekday: 30000, price_weekend: 36000, capacity: "26äºº", detail: "é…ç½®ï¼šå…¨æ£ŸåŠ åºŠä½¿ç”¨" }
            ],
            'gouding': [
                { title: "3æˆ¿åŒ…æ£Ÿ (10äºº)", price_weekday: 10000, price_weekend: 14000, capacity: "10äºº", detail: "é…ç½®ï¼š3æˆ¿ (2/4/4)" },
                { title: "4æˆ¿åŒ…æ£Ÿ (12äºº)", price_weekday: 12000, price_weekend: 16000, capacity: "12äºº", detail: "é…ç½®ï¼š4æˆ¿ (2/4/4/2)" }
            ],
            'double': [
                { title: "é›™é¤¨è¯è³£åŒ…æ£Ÿ (32-38äºº)", price_weekday: 42000, price_weekend: 52000, capacity: "38äºº", detail: "åŒ…å«ï¼šä½ å¥½å“‡(26äºº) + æºé ‚(12äºº)" }
            ]
        };

        let selectedStart, selectedEnd;
        let currentVenue = "", currentPlan = "", currentPrice = "";
        let autoParams = {}; 
        let selectedGuestRange = "";

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auto') === 'yes') {
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('auto-send-overlay').style.display = 'flex';
                
                autoParams = {
                    sDate: urlParams.get('start'), eDate: urlParams.get('end'),
                    venue: urlParams.get('venue'), plan: urlParams.get('plan'),
                    price: urlParams.get('price'), name: urlParams.get('name'), phone: urlParams.get('phone')
                };

                setTimeout(() => { document.getElementById('manual-send-btn').style.display = 'inline-flex'; }, 5000);

                liff.init({ liffId: LIFF_ID }).then(() => {
                    if(!liff.isLoggedIn()) { liff.login(); } 
                    else { setTimeout(() => { forceSend(); }, 800); }
                }).catch(e => {
                    console.error(e);
                    document.getElementById('auto-send-overlay').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    Swal.fire("ç³»çµ±éŒ¯èª¤", "è«‹æ‰‹å‹•å¡«å¯«", "error");
                });
                return; 
            }

            flatpickr("#date-range", {
                mode: "range", locale: "zh_tw", dateFormat: "Y-m-d", minDate: "today",
                onClose: (dates) => {
                    if (dates.length === 2) {
                        selectedStart = dates[0];
                        selectedEnd = dates[1];
                        document.getElementById('step-3').classList.remove('active');
                        document.getElementById('step-4').classList.remove('active');
                        document.getElementById('venue-results').style.display = 'none';
                        document.getElementById('recommendation-area').style.display = 'none';
                    }
                }
            });
            liff.init({ liffId: LIFF_ID }).then(() => console.log("LIFF Ready"));
        });

        function selectGuestRange(range, btn) {
            selectedGuestRange = range;
            document.querySelectorAll('.guest-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            const step2 = document.getElementById('step-2');
            step2.classList.add('active');
            step2.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (selectedStart && selectedEnd) { startQuery(); }
        }

        // ============================================
        // ä¿®æ”¹å¾Œçš„ startQueryï¼šåŠ å…¥èƒŒæ™¯é€šçŸ¥åŠŸèƒ½
        // ============================================
        function startQuery() {
            if (!selectedGuestRange) { Swal.fire({icon:'warning', title:'è«‹å…ˆé¸æ“‡äººæ•¸', confirmButtonColor:'#BFA15F'}); document.getElementById('step-1').scrollIntoView(); return; }
            if (!selectedStart || !selectedEnd) { Swal.fire({icon:'warning', title:'è«‹å…ˆé¸æ“‡æ—¥æœŸ', confirmButtonColor:'#BFA15F'}); return; }
            
            const loadBox = document.getElementById('loading-box');
            loadBox.style.display = 'block';
            document.getElementById('venue-results').style.display = 'none';
            document.getElementById('recommendation-area').style.display = 'none';
            document.getElementById('step-3').classList.remove('active');
            
            const startStr = formatDate(selectedStart);
            const endStr = formatDate(selectedEnd);

            // â˜…â˜…â˜… æ–°å¢ï¼šç™¼é€æŸ¥è©¢ç´€éŒ„çµ¦ç®¡ç†å“¡ (Spy Mode) â˜…â˜…â˜…
            // å˜—è©¦ç²å–æŒ‰éˆ•ä¸Šçš„æ–‡å­— (ä¾‹å¦‚ "6 - 12 äºº")
            let peopleLabel = "æœªçŸ¥äººæ•¸";
            try {
                const activeBtn = document.querySelector('.guest-btn.active h4');
                if(activeBtn) peopleLabel = activeBtn.innerText;
            } catch(e){}

            // åŸ·è¡ŒèƒŒæ™¯å‚³é€
            sendCheckLog(startStr, endStr, peopleLabel);
            // â˜…â˜…â˜… çµæŸæ–°å¢ â˜…â˜…â˜…

            fetch(`${GAS_URL}?start=${startStr}&end=${endStr}`)
            .then(res => res.json())
            .then(data => {
                loadBox.style.display = 'none';
                renderVenues(data.status);
                if (data.suggestions && data.suggestions.length > 0) {
                    renderRecommendations(data.suggestions);
                }
            })
            .catch(err => {
                console.error(err);
                loadBox.style.display = 'none';
                Swal.fire({icon:'error', title:'é€£ç·šéŒ¯èª¤', text: 'è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦', confirmButtonColor:'#2C3E50'});
            });
        }

        // ============================================
        // æ–°å¢å‡½å¼ï¼šç™¼é€æŸ¥è©¢ç´€éŒ„ (èƒŒæ™¯åŸ·è¡Œï¼Œä¸æ‰“æ“¾å®¢äºº)
        // ============================================
        function sendCheckLog(sDate, eDate, people) {
            // å˜—è©¦æŠ“å–å®¢äººè³‡æ–™ (å¦‚æœ LIFF å·²ç™»å…¥)
            let guestName = "è¨ªå®¢ (æœªç™»å…¥)";
            
            // æª¢æŸ¥ LIFF æ˜¯å¦å·²åˆå§‹åŒ–ä¸”å·²ç™»å…¥
            if (liff && liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    guestName = profile.displayName; // æŠ“å– LINE æš±ç¨±
                    doSendLog(sDate, eDate, people, guestName);
                }).catch(err => {
                    console.error('Profile Error:', err);
                    doSendLog(sDate, eDate, people, guestName);
                });
            } else {
                doSendLog(sDate, eDate, people, guestName);
            }
        }

        function doSendLog(sDate, eDate, people, name) {
            const payload = {
                action: "check_log", // å‘Šè¨´ GAS é€™æ˜¯ã€ŒæŸ¥è©¢ç´€éŒ„ã€
                name: name,
                sDate: sDate,
                eDate: eDate,
                people: people
            };

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" },
            }).catch(e => console.log("Log error:", e));
        }

        function renderVenues(status) {
            const container = document.getElementById('venue-results');
            container.style.display = 'grid';
            container.innerHTML = '';

            let venuesToShow = [];
            if (selectedGuestRange === 'small') {
                venuesToShow = [
                    { key: 'hello', name: 'ä½ å¥½å“‡å¯“æ‰€ (ä¸»é¤¨)', available: status.hello.available, sub: 'Hello House' },
                    { key: 'gouding', name: 'æºé ‚æ°‘å®¿ (äºŒé¤¨)', available: status.gouding.available, sub: 'Godin House' }
                ];
            } else if (selectedGuestRange === 'medium') {
                venuesToShow = [ { key: 'hello', name: 'ä½ å¥½å“‡å¯“æ‰€ (ä¸»é¤¨)', available: status.hello.available, sub: 'Hello House' } ];
            } else if (selectedGuestRange === 'large') {
                const bothFree = status.hello.available && status.gouding.available;
                venuesToShow = [ { key: 'double', name: 'é›™é¤¨è¯è³£åŒ…æ£Ÿ', available: bothFree, sub: 'ä½ å¥½å“‡ + æºé ‚' } ];
            }

            venuesToShow.forEach(v => {
                const div = document.createElement('div');
                div.className = `venue-card ${v.available ? 'available' : 'disabled'}`;
                const icon = v.available ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-xmark"></i>';
                let displayStatus = v.available ? 'ç«‹å³é è¨‚' : 'å·²æ»¿æˆ¿';
                if (!v.available && selectedGuestRange === 'large') displayStatus = "éƒ¨åˆ†æˆ–å…¨éƒ¨æ»¿æˆ¿";

                div.innerHTML = `<h4>${v.name}</h4><span>${v.sub}</span><div class="status-badge">${icon} ${displayStatus}</div>`;
                if(v.available) { div.onclick = () => showPlans(v.key, v.name); }
                container.appendChild(div);
            });
        }

        function renderRecommendations(list) {
            if (selectedGuestRange === 'large') return; 
            const box = document.getElementById('recommendation-area');
            box.style.display = 'block';
            let html = `<div class="rec-title"><i class="fa-solid fa-bell"></i> æœ¬æª”æœŸå·²æ»¿ï¼Œç‚ºæ‚¨æ¨è–¦ï¼š</div>`;
            list.forEach(item => {
                const tagClass = item.tag === 'part' ? 'rec-tag part' : 'rec-tag';
                const tagName = item.tag === 'part' ? 'ç¸®çŸ­å¤©æ•¸' : 'æ¨è–¦ç©ºæª”';
                html += `<div class="rec-item" onclick="applyDate('${item.start}', '${item.end}')"><div><span class="${tagClass}">${tagName}</span><span style="font-weight:bold; color:#555;">${item.start} ~ ${item.end}</span><span style="font-size:0.8rem; color:#888;">(${item.label})</span></div><i class="fa-solid fa-angle-right" style="color:#CCC;"></i></div>`;
            });
            box.innerHTML = html;
        }

        function applyDate(s, e) {
            const fp = document.querySelector("#date-range")._flatpickr;
            fp.setDate([s, e]);
            selectedStart = new Date(s);
            selectedEnd = new Date(e);
            startQuery(); 
        }

        function showPlans(key, name) {
            currentVenue = name;
            document.querySelectorAll('.venue-card').forEach(el => el.style.opacity = '0.5');
            event.currentTarget.style.opacity = '1';
            event.currentTarget.style.borderColor = 'var(--c-gold)';

            const container = document.getElementById('plan-container');
            container.innerHTML = '';
            const plans = ROOM_PLANS[key] || [];
            const calc = calculatePrice(selectedStart, selectedEnd);

            plans.forEach(p => {
                const total = (calc.weekdays * p.price_weekday) + (calc.weekends * p.price_weekend);
                const div = document.createElement('div');
                div.className = 'plan-card';
                div.innerHTML = `<span class="plan-capacity">${p.capacity}</span><div class="plan-title">${p.title}</div><div class="plan-detail">${p.detail}</div><div class="plan-price">$${total.toLocaleString()} <small>(${calc.weekdays}å¹³æ—¥+${calc.weekends}å‡æ—¥)</small></div>`;
                div.onclick = () => {
                    document.querySelectorAll('.plan-card').forEach(e => e.classList.remove('selected'));
                    div.classList.add('selected');
                    currentPlan = p.title;
                    currentPrice = `$${total.toLocaleString()}`;
                    const step4 = document.getElementById('step-4');
                    step4.classList.add('active');
                    setTimeout(() => step4.scrollIntoView({ behavior: 'smooth', block: 'start' }), 300);
                };
                container.appendChild(div);
            });
            const step3 = document.getElementById('step-3');
            step3.classList.add('active');
            step3.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function calculatePrice(start, end) {
            let weekdays = 0;
            let weekends = 0;
            let cur = new Date(start);
            const stop = new Date(end);
            while(cur < stop) {
                const day = cur.getDay();
                if (day === 5 || day === 6) weekends++; else weekdays++;
                cur.setDate(cur.getDate() + 1);
            }
            return { weekdays, weekends };
        }

        function handleSend() {
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();

            if(!name || !phone) { Swal.fire({ icon: 'warning', title: 'è³‡æ–™ä¸å®Œæ•´', text: 'è«‹è¼¸å…¥å§“åèˆ‡é›»è©±', confirmButtonColor: '#BFA15F' }); return; }

            // 1. æº–å‚™è³‡æ–™
            autoParams = { sDate: formatDate(selectedStart), eDate: formatDate(selectedEnd), venue: currentVenue, plan: currentPlan, price: currentPrice, name: name, phone: phone };

            // ==========================================
            // [æ–°åŠŸèƒ½] å‚³é€å‚™ä»½åˆ° GAS (ä¸è«–æ˜¯å¦æˆåŠŸå–šèµ·LINEï¼Œé€™è£¡éƒ½æœƒåŸ·è¡Œ)
            // ==========================================
            sendBackupToGas(autoParams);

            // 2. åˆ¤æ–·è£ç½®é¡å‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (liff.isInClient() || isMobile) {
                forceSend(); // ç›´æ¥å–šèµ· LINE APP
            } else {
                generateLiffQrCode(name, phone); // é›»è…¦ç‰ˆæ‰é¡¯ç¤º QR Code
            }
        }

        // [æ–°åŠŸèƒ½] ç¨ç«‹çš„å‚™ä»½ç™¼é€å‡½å¼
        function sendBackupToGas(p) {
            // ä½¿ç”¨ POST ç™¼é€ JSON å­—ä¸²ï¼Œæ¨™è¨» action ç‚º inquiry_backup
            const payload = {
                action: "inquiry_backup",
                name: p.name,
                phone: p.phone,
                sDate: p.sDate,
                eDate: p.eDate,
                venue: p.venue,
                plan: p.plan,
                price: p.price
            };

            // ä½¿ç”¨ fetch ç™¼é€ï¼Œä¸ç­‰å¾…å›æ‡‰ (fire and forget)ï¼Œé¿å…å½±éŸ¿ä½¿ç”¨è€…é«”é©—
            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" }, // ä½¿ç”¨ text/plain é¿å… CORS é æª¢è«‹æ±‚å•é¡Œ
            }).catch(err => {
                console.error("Backup send failed:", err);
            });
        }

        function generateLiffQrCode(name, phone) {
            const params = new URLSearchParams({
                start: formatDate(selectedStart), end: formatDate(selectedEnd),
                venue: currentVenue, plan: currentPlan, price: currentPrice,
                name: name, phone: phone, auto: "yes"
            });
            const liffUrl = `https://liff.line.me/${LIFF_ID}?${params.toString()}`;
            
            Swal.fire({
                title: `${name} æ‚¨å¥½ï¼`,
                html: `<br>
                    <div style="font-size:0.9rem; color:#666; margin-bottom:15px; line-height:1.5;">
                        æ„Ÿè¬æ‚¨çš„è©¢å•ï¼è«‹é–‹å•Ÿæ‰‹æ©Ÿ LINE æƒæä¸‹æ–¹ QR Code<br><br>
                        ç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨ç™¼é€è©¢åƒ¹å–®ã€‚
                    </div>
                    <div id="qrcode" style="display:flex; justify-content:center; margin:15px auto;"></div>
                    <div style="font-size:0.8rem; color:#888; margin-top:10px;">
                        <i class="fa-solid fa-bell"></i> ç®¡å®¶æ”¶åˆ°å¾Œå°‡ç›¡å¿«å›è¦†ã€‚<br><br>
                        å»ºè­°æ‚¨å…ˆæ’¥ç©ºé–±è®€ <a href="${RULES_URL}" target="_blank" style="color:#BFA15F; text-decoration:underline;">å…¥ä½é ˆçŸ¥</a>
                    </div>
                `,
                showConfirmButton: true, confirmButtonText: 'å·²æƒæå‚³é€', confirmButtonColor: '#2C3E50', width: 420,
                didOpen: () => {
                    new QRCode(document.getElementById("qrcode"), { text: liffUrl, width: 200, height: 200, colorDark : "#2C3E50", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M });
                }
            });
        }

        function forceSend() {
            const p = autoParams;
            if (!p.name) return;
            
            const message = `ã€è¨‚æˆ¿è©¢åƒ¹å–®ã€‘\nğŸ“… æ—¥æœŸï¼š${p.sDate} ~ ${p.eDate}\nğŸ¨ é¤¨åˆ¥ï¼š${p.venue}\nğŸ›ï¸ æ–¹æ¡ˆï¼š${p.plan}\nğŸ’° ç³»çµ±ç®—åƒ¹ï¼š${p.price}\n--------------------------\nğŸ‘¤ è¨‚æˆ¿äººï¼š${p.name}\nğŸ“± é›»è©±ï¼š${p.phone}\n--------------------------\næˆ‘æ˜¯ ${p.name}ï¼Œæƒ³é è¨‚ä»¥ä¸Šæª”æœŸï¼Œè«‹å•æ˜¯å¦æœ‰ç©ºæˆ¿ï¼Ÿ`;
            
            const lineUrl = `https://line.me/R/oaMessage/${LINE_OFFICIAL_ID}/?text=${encodeURIComponent(message)}`;

            Swal.fire({
                title: `${p.name} æ‚¨å¥½ï¼`,
                html: `<br>
                    <div style="text-align:left; font-size:0.95rem; line-height:1.6; color:#555;">
                        <p>æ„Ÿè¬æ‚¨çš„è©¢å•ï¼Œè©¢åƒ¹å–®å·²æº–å‚™å°±ç·’ã€‚<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‚³é€ã€‚</p>
                        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
                        <p style="font-size:0.85rem; color:#888;">
                            <i class="fa-solid fa-bell" style="color:var(--c-gold)"></i> 
                            ç®¡å®¶æ”¶åˆ°è¨Šæ¯å¾Œå°‡ç›¡å¿«å›è¦†æ‚¨ã€‚<br><br>
                            å»ºè­°æ‚¨å¯å…ˆè©³é–±ï¼š<a href="${RULES_URL}" target="_blank" style="color:var(--c-gold); font-weight:bold; text-decoration:underline;">å…¥ä½é ˆçŸ¥èˆ‡ç”Ÿæ´»å…¬ç´„</a>
                        </p>
                    </div>
                `,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'ç«‹å³å‚³é€ LINE',
                cancelButtonText: 'ç¨å¾Œå†å‚³',
                confirmButtonColor: '#06C755'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = lineUrl;
                }
            });
        }

        function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    </script>
</body>
</html>
