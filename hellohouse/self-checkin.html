<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‡ªåŠ©å…¥ä½ç™»è¨˜ | ä½ å¥½å“‡å¯“æ‰€</title>
    <meta name="robots" content="noindex, nofollow"> 

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        :root { --c-dark: #2C3E50; --c-gold: #BFA15F; --c-gold-light: #F9F5EB; --c-red: #A94442; --c-gray: #7F8C8D; --c-white: #FFFFFF; --font-serif: 'Noto Serif TC', serif; --font-sans: 'Noto Sans TC', sans-serif; --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.06); }
        *, *::before, *::after { box-sizing: border-box; }
        
        body { margin: 0; font-family: var(--font-sans); background-color: #F5F5F5; color: var(--c-dark); line-height: 1.7; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; overscroll-behavior: none; }

        .navbar { background: var(--c-dark); height: 60px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; width: 100%; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-logo { color: var(--c-gold); font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-decoration: none; }

        .header-section { margin-top: 60px; padding: 40px 20px; text-align: center; background: var(--c-dark); color: white; }
        .header-section h1 { margin: 0; font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 3px; font-weight: 500; }
        .header-section p { margin: 5px 0 0; font-size: 0.8rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 2px; }

        .container { width: 95%; max-width: 800px; margin: -30px auto 40px; position: relative; z-index: 10; }

        #capture-area { background-color: var(--c-white); padding: 40px; border-radius: 4px; box-shadow: var(--shadow-card); border-top: 6px solid var(--c-gold); }

        .section-title { font-family: var(--font-serif); font-size: 1.2rem; color: var(--c-dark); margin: 30px 0 20px; padding-left: 15px; border-left: 4px solid var(--c-gold); display: flex; align-items: center; }
        
        /* æ­¥é©Ÿæµç¨‹å¡ç‰‡ */
        .steps-box { background: #FFFCF5; border: 2px solid #E2E8F0; border-radius: 8px; padding: 25px; margin-bottom: 30px; position: relative; }
        .steps-title { font-weight: bold; color: var(--c-gold); margin-bottom: 15px; display: block; border-bottom: 1px dashed #DDD; padding-bottom: 10px; }
        .step-item { display: flex; margin-bottom: 20px; position: relative; }
        .step-item:last-child { margin-bottom: 0; }
        .step-item:not(:last-child)::after { content: ''; position: absolute; left: 14px; top: 35px; bottom: -15px; width: 2px; background: #E2E8F0; }
        .step-num { width: 30px; height: 30px; background: var(--c-dark); color: white; border-radius: 50%; text-align: center; line-height: 30px; font-weight: bold; margin-right: 15px; flex-shrink: 0; z-index: 1; }
        .step-item.highlight .step-num { background: var(--c-red); box-shadow: 0 0 0 3px rgba(169, 68, 66, 0.2); }
        .step-content h4 { margin: 0 0 5px 0; color: var(--c-dark); font-size: 1rem; font-weight: bold; }
        .step-content p { margin: 0; color: #666; font-size: 0.9rem; line-height: 1.5; }
        .highlight-price { color: var(--c-red); font-weight: bold; background: #FDEDEC; padding: 0 4px; border-radius: 2px; font-family: monospace; font-size: 1.1em; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 5px; }
        .col-full { grid-column: 1 / -1; }
        .form-label { display: block; font-size: 0.85rem; color: var(--c-gray); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #DDD; border-radius: 4px; background: #FAFAFA; transition: 0.3s; }
        .form-input:focus { outline: none; border-color: var(--c-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(191, 161, 95, 0.1); }
        .form-input.readonly { background: #F9F5EB; border-color: #E0D6C3; color: #8A7A5B; font-weight: bold; cursor: pointer; }

        .house-selector { display: flex; gap: 15px; }
        .house-btn { flex: 1; padding: 12px; border: 1px solid #DDD; border-radius: 6px; background: #FAFAFA; cursor: pointer; transition: 0.3s; text-align: center; position: relative; }
        .house-btn h4 { margin: 0; font-size: 1rem; color: var(--c-dark); font-weight: bold; }
        .house-btn:hover { background: #F0F0F0; }
        .house-btn.active { border: 2px solid var(--c-gold); background: var(--c-gold-light); box-shadow: 0 4px 10px rgba(191, 161, 95, 0.2); }
        .house-btn.active::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -10px; right: -5px; background: var(--c-gold); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }

        .id-upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .id-box { border: 2px dashed #BDC3C7; background: #FAFAFA; border-radius: 8px; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; transition: 0.3s; }
        .id-box:hover { border-color: var(--c-gold); background: #FFFCF5; }
        .id-box i { font-size: 2rem; color: #BDC3C7; margin-bottom: 10px; }
        .id-box span { font-size: 0.9rem; color: #999; font-weight: bold; }
        .id-preview { width: 100%; height: 100%; object-fit: contain; display: none; position: absolute; top: 0; left: 0; background: #fff; }
        .id-watermark-hint { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 0.7rem; text-align: center; padding: 2px 0; display: none; }

        .checkbox-wrapper { display: flex; align-items: flex-start; margin-top: 20px; gap: 10px; font-size: 0.95rem; cursor: pointer; }
        .checkbox-wrapper input { margin-top: 5px; transform: scale(1.2); accent-color: var(--c-gold); }
        .action-area { text-align: center; margin-top: 40px; }
        .btn-submit { background-color: var(--c-dark); color: var(--c-gold); border: 1px solid var(--c-dark); padding: 18px 60px; font-size: 1.1rem; font-weight: bold; letter-spacing: 1px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2); display: inline-flex; align-items: center; gap: 10px; }
        .btn-submit:hover { background-color: var(--c-gold); color: white; border-color: var(--c-gold); transform: translateY(-3px); }
        .btn-submit:disabled { background-color: #BDC3C7; border-color: #BDC3C7; cursor: not-allowed; }
        .footer { text-align: center; color: #999; font-size: 0.8rem; padding: 40px 0; margin-top: auto; }
        .highlight-error { animation: shake 0.5s; border-color: var(--c-red) !important; background-color: #FDEDEC !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        @media (max-width: 768px) {
            #capture-area { padding: 30px 20px; }
            .form-grid, .id-upload-grid { grid-template-columns: 1fr; }
            .col-full { grid-column: span 1; }
            .house-selector { flex-direction: column; }
            .header-section h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar"><a href="#" class="nav-logo">ä½ å¥½å“‡å¯“æ‰€ | æºé ‚æ°‘å®¿</a></nav>
    <div class="header-section"><h1>è‡ªåŠ©å…¥ä½ç™»è¨˜</h1><p>Self Check-in Registration</p></div>

    <div class="container">
        <div id="capture-area">
            <div style="text-align:center; margin-bottom:30px; border-bottom:2px solid #EEE; padding-bottom:20px;">
                <h2 style="margin:0; color:var(--c-dark); font-family:var(--font-serif);">å…¥ä½èº«åˆ†ç™»è¨˜</h2>
                <span style="color:var(--c-gray); font-size:0.9rem;">Identity Verification</span>
            </div>

            <div class="steps-box">
                <span class="steps-title"><i class="fa-solid fa-list-check"></i> è‡ªåŠ©å…¥ä½æµç¨‹</span>
                
                <div class="step-item highlight">
                    <div class="step-num"><i class="fa-solid fa-money-bill-transfer"></i></div>
                    <div class="step-content">
                        <h4 style="color:var(--c-red);">æ­¥é©Ÿä¸€ï¼šåŒ¯æ¬¾æŠ¼é‡‘ (è«‹å„ªå…ˆå®Œæˆ)</h4>
                        <p>è«‹å…ˆåŒ¯æ¬¾æŠ¼é‡‘ <span class="highlight-price">$5,000</span> è‡³è¨‚æˆ¿æ™‚æä¾›çµ¦æ‚¨çš„éŠ€è¡Œå¸³æˆ¶ã€‚</p>
                        <p style="margin-top:5px; font-size:0.85rem; color:#888;">âš ï¸ è«‹å‹™å¿…å®ŒæˆåŒ¯æ¬¾å¾Œï¼Œå†å¡«å¯«ä¸‹æ–¹è³‡æ–™ã€‚</p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <h4>ä¸Šå‚³è­‰ä»¶ (ç™»è¨˜ä½¿ç”¨)</h4>
                        <p>è«‹æ‹æ”ã€Œèº«åˆ†è­‰æ­£åé¢ã€ä¸¦ä¸Šå‚³è‡³ä¸‹æ–¹æ¬„ä½ã€‚</p>
                        <p style="font-size:0.8rem; color:#A0AEC0; margin-top:3px;"><i class="fa-solid fa-lock"></i> åƒ…ä¾›è§€å…‰å±€æ—…å®¿ç³»çµ±å»ºæª”æŸ¥æ ¸ï¼Œçµ•ç„¡ä»–ç”¨ã€‚</p>
                    </div>
                </div>
                
                <div class="step-item">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <h4>å¡«å¯«è³‡æ–™ä¸¦é€å‡º</h4>
                        <p>å¡«å¯«è¨‚æˆ¿äººè³‡è¨Šèˆ‡<strong>åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼</strong>ã€‚</p>
                        <p style="font-weight:bold; color:var(--c-gold); margin-top:5px;">ç®¡å®¶ç¢ºèªæ¬¾é …èˆ‡è­‰ä»¶ç„¡èª¤å¾Œï¼Œå³ç™¼é€å…¥ä½å¯†ç¢¼ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group col-full">
                    <label class="form-label">å…¥ä½é¤¨åˆ¥ (Select House)</label>
                    <input type="hidden" id="house-select" value="ä½ å¥½å“‡å¯“æ‰€">
                    <div class="house-selector">
                        <div class="house-btn active" onclick="selectHouse('ä½ å¥½å“‡å¯“æ‰€', this)"><h4>ä½ å¥½å“‡å¯“æ‰€</h4></div>
                        <div class="house-btn" onclick="selectHouse('æºé ‚æ°‘å®¿', this)"><h4>æºé ‚æ°‘å®¿</h4></div>
                    </div>
                </div>

                <div class="form-group col-full">
                    <label class="form-label">å…¥ä½æ—¥æœŸ (Check-in Date)</label>
                    <input type="text" id="checkin-date" class="form-input readonly" placeholder="è«‹é¸æ“‡å…¥ä½æ—¥æœŸ..." readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¨‚æˆ¿äººå§“å (Name)</label>
                    <input type="text" id="booker-name" class="form-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">è¯çµ¡é›»è©± (Phone)</label>
                    <input type="tel" id="booker-phone" class="form-input" placeholder="09xxxxxxxx">
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="color:var(--c-gold);">åŒ¯æ¬¾éŠ€è¡Œ (Bank)</label>
                    <select id="bank-name" class="form-input" style="border-color:var(--c-gold);">
                        <option value="" disabled selected>è«‹é¸æ“‡éŠ€è¡Œ...</option>
                        <option value="822 ä¸­åœ‹ä¿¡è¨—">822 ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="013 åœ‹æ³°ä¸–è¯">013 åœ‹æ³°ä¸–è¯</option>
                        <option value="012 å°åŒ—å¯Œé‚¦">012 å°åŒ—å¯Œé‚¦</option>
                        <option value="808 ç‰å±±éŠ€è¡Œ">808 ç‰å±±éŠ€è¡Œ</option>
                        <option value="004 å°ç£éŠ€è¡Œ">004 å°ç£éŠ€è¡Œ</option>
                        <option value="700 ä¸­è¯éƒµæ”¿">700 ä¸­è¯éƒµæ”¿</option>
                        <option value="812 å°æ–°éŠ€è¡Œ">812 å°æ–°éŠ€è¡Œ</option>
                        <option value="007 ç¬¬ä¸€éŠ€è¡Œ">007 ç¬¬ä¸€éŠ€è¡Œ</option>
                        <option value="008 è¯å—éŠ€è¡Œ">008 è¯å—éŠ€è¡Œ</option>
                        <option value="006 åˆä½œé‡‘åº«">006 åˆä½œé‡‘åº«</option>
                        <option value="009 å½°åŒ–éŠ€è¡Œ">009 å½°åŒ–éŠ€è¡Œ</option>
                        <option value="807 æ°¸è±éŠ€è¡Œ">807 æ°¸è±éŠ€è¡Œ</option>
                        <option value="005 åœŸåœ°éŠ€è¡Œ">005 åœŸåœ°éŠ€è¡Œ</option>
                        <option value="å…¶ä»–">å…¶ä»–éŠ€è¡Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" style="color:var(--c-gold);">å¸³è™Ÿæœ«äº”ç¢¼ (Last 5 Digits)</label>
                    <input type="text" id="bank-last-5" class="form-input" placeholder="è«‹è¼¸å…¥å¾Œäº”ç¢¼" style="border-color:var(--c-gold);">
                </div>
            </div>

            <div class="section-title">ä¸Šå‚³èº«åˆ†è­‰ä»¶ (è‡ªå‹•åŠ æµ®æ°´å°)</div>
            <div class="id-upload-grid">
                <div class="id-box" onclick="document.getElementById('file-front').click()">
                    <i class="fa-regular fa-id-card"></i><span>é–‹å•Ÿç›¸æ©Ÿæ‹ã€æ­£é¢ã€‘</span>
                    <img id="preview-front" class="id-preview"><div class="id-watermark-hint" id="hint-front">å·²åŠ ä¸Šå®‰å…¨æµ®æ°´å°</div>
                    <input type="file" id="file-front" accept="image/*" capture="environment" hidden onchange="handleIdUpload(this, 'preview-front', 'hint-front')">
                </div>
                <div class="id-box" onclick="document.getElementById('file-back').click()">
                    <i class="fa-solid fa-id-card"></i><span>é–‹å•Ÿç›¸æ©Ÿæ‹ã€åé¢ã€‘</span>
                    <img id="preview-back" class="id-preview"><div class="id-watermark-hint" id="hint-back">å·²åŠ ä¸Šå®‰å…¨æµ®æ°´å°</div>
                    <input type="file" id="file-back" accept="image/*" capture="environment" hidden onchange="handleIdUpload(this, 'preview-back', 'hint-back')">
                </div>
            </div>

            <label class="checkbox-wrapper">
                <input type="checkbox" id="agree-check">
                <span>æˆ‘å·²å®ŒæˆåŒ¯æ¬¾ï¼Œä¸¦ç¢ºèªä¸Šè¿°å§“åèˆ‡è­‰ä»¶ç›¸ç¬¦ã€‚</span>
            </label>
        </div>

        <div class="action-area">
            <button id="btn-submit" class="btn-submit" onclick="submitForm()">
                <span id="btn-text">ç¢ºèªè³‡æ–™ä¸¦ä¸Šå‚³</span>
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </button>
            <p style="font-size:0.8rem; color:#999; margin-top:15px;">ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆé«˜è§£æ PDF ä¸¦åŠ å¯†å‚³è¼¸</p>
        </div>
    </div>

    <footer class="footer">Â© 2025 ä½ å¥½å“‡å¯“æ‰€ & æºé ‚æ°‘å®¿. All Rights Reserved.</footer>

    <canvas id="watermark-canvas" style="display:none;"></canvas>

    <script>
        const GAS_APP_URL = "https://script.google.com/macros/s/AKfycbzfqpbILo5s6P0593PcdpYVie5cbyYGhxe83-Xbzs5QHymN6uNwo37ziT0As6zj1tZk1w/exec";
        const MY_LIFF_ID = "2008582194-P7EnGkNk"; 

        const { jsPDF } = window.jspdf;
        let datePicker;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof liff !== 'undefined') { liff.init({ liffId: MY_LIFF_ID }).catch(err => console.error(err)); }
            
            datePicker = flatpickr("#checkin-date", { 
                minDate: "today", 
                dateFormat: "Y-m-d", 
                locale: "zh_tw",
                disableMobile: "true" 
            });
        });

        function selectHouse(value, element) {
            document.getElementById('house-select').value = value;
            document.querySelectorAll('.house-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        // â˜…â˜…â˜… æ™ºèƒ½é˜²å‘†ï¼šæª¢æ¸¬åœ–ç‰‡æ¯”ä¾‹ â˜…â˜…â˜…
        function handleIdUpload(input, previewId, hintId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // é˜²å‘†æª¢æ¸¬ï¼šèº«åˆ†è­‰æ‡‰ç‚ºæ©«å‘ (å¯¬ > é«˜)
                        if (img.height > img.width) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'æ ¼å¼éŒ¯èª¤',
                                text: 'åµæ¸¬åˆ°ç…§ç‰‡ç‚ºç›´å‘ï¼è«‹æ©«å‘æ‹æ”èº«åˆ†è­‰ï¼Œä¸¦ç¢ºä¿ç•«é¢æ»¿ç‰ˆæ¸…æ™°ã€‚',
                                confirmButtonColor: '#BFA15F'
                            });
                            // æ¸…ç©ºæ¬„ä½
                            input.value = "";
                            return;
                        }

                        const canvas = document.getElementById('watermark-canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // é«˜ç•«è³ªè¨­å®š
                        const maxWidth = 1000;
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;

                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        const houseName = document.getElementById('house-select').value;
                        const text = `åƒ…ä¾› ${houseName} ç™»è¨˜å…¥ä½ä½¿ç”¨`;
                        
                        ctx.font = "bold 30px Arial";
                        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        
                        ctx.save();
                        ctx.translate(canvas.width/2, canvas.height/2);
                        ctx.rotate(-Math.PI / 6);
                        
                        // å¯†é›†æµ®æ°´å°
                        ctx.fillText(text, 0, -150);
                        ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                        ctx.fillText(text, 0, 0);
                        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
                        ctx.fillText(text, 0, 150);
                        
                        ctx.restore();

                        const processedData = canvas.toDataURL('image/jpeg', 0.8);
                        const preview = document.getElementById(previewId);
                        preview.src = processedData;
                        preview.style.display = 'block';
                        document.getElementById(hintId).style.display = 'block';
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitForm() {
            const name = document.getElementById('booker-name').value.trim();
            const phone = document.getElementById('booker-phone').value.trim();
            const house = document.getElementById('house-select').value;
            const date = document.getElementById('checkin-date').value;
            const bankName = document.getElementById('bank-name').value;
            const bankCode = document.getElementById('bank-last-5').value.trim();
            const agree = document.getElementById('agree-check').checked;
            
            const hasFront = document.getElementById('preview-front').src.includes('base64');
            const hasBack = document.getElementById('preview-back').src.includes('base64');

            if (!date) return alertAndFocus("è«‹é¸æ“‡å…¥ä½æ—¥æœŸ", "checkin-date");
            if (!name) return alertAndFocus("è«‹è¼¸å…¥è¨‚æˆ¿äººå§“å", "booker-name");
            if (!phone) return alertAndFocus("è«‹è¼¸å…¥è¯çµ¡é›»è©±", "booker-phone");
            if (!bankName) return alertAndFocus("è«‹é¸æ“‡åŒ¯æ¬¾éŠ€è¡Œ", "bank-name");
            if (!bankCode) return alertAndFocus("è«‹è¼¸å…¥å¸³è™Ÿæœ«äº”ç¢¼", "bank-last-5");
            if (!hasFront || !hasBack) return alertAndFocus("è«‹ä¸Šå‚³è­‰ä»¶æ­£åé¢", "capture-area");
            if (!agree) return alertAndFocus("è«‹ç¢ºèªè³‡æ–™ä¸¦å‹¾é¸åŒæ„", "agree-check");

            const confirmResult = await Swal.fire({
                title: 'è³‡æ–™ç¢ºèª',
                html: `
                    <div style="text-align:left; font-size:0.9rem;">
                    ğŸ“… æ—¥æœŸï¼š${date}<br>
                    ğŸ‘¤ å§“åï¼š${name}<br>
                    ğŸ’° åŒ¯æ¬¾ï¼š<span style="color:#C5A065; font-weight:bold;">${bankName} (${bankCode})</span>
                    </div>
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                    <span style="font-size:0.8rem; color:#888;">ç¢ºèªè³‡æ–™ç„¡èª¤å¾Œå°‡é€å‡ºæ­¸æª”</span>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                cancelButtonText: 'è¿”å›ä¿®æ”¹',
                confirmButtonColor: '#2C3E50'
            });

            if (!confirmResult.isConfirmed) return;

            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            btn.disabled = true;
            btnText.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> é«˜è§£æ PDF ç”Ÿæˆä¸­...';

            // â˜…â˜…â˜… è‡ªå‹•é™ç´šæ©Ÿåˆ¶ (Fail-Safe) â˜…â˜…â˜…
            // å˜—è©¦é«˜ç•«è³ªï¼Œå¤±æ•—å‰‡è‡ªå‹•é™ç´šé‡è©¦
            async function tryUpload(qualityScale) {
                const dateStr = date.replace(/-/g, '');
                // æª”åï¼šå…¥ä½æ—¥æœŸ_å§“å_éŠ€è¡Œ+æœ«äº”ç¢¼.pdf
                const fileName = `${dateStr}_${name}_${bankName}${bankCode}.pdf`;

                const captureArea = document.getElementById("capture-area");
                const canvasData = await html2canvas(captureArea, { scale: qualityScale, useCORS: true, backgroundColor: "#ffffff", logging: false });
                const imgData = canvasData.toDataURL('image/jpeg', 0.6);
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                if (imgHeight > pdf.internal.pageSize.getHeight()) {
                    const longPdf = new jsPDF('p', 'mm', [pdfWidth, imgHeight + 10]);
                    longPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = longPdf.output('datauristring');
                } else {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = pdf.output('datauristring');
                }

                btnText.innerHTML = `<i class="fa-solid fa-cloud-arrow-up fa-spin"></i> ä¸Šå‚³é›²ç«¯ (Scale:${qualityScale})...`;

                const response = await fetch(GAS_APP_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ type: "UPLOAD_IMG", image: pdfBase64, filename: fileName, user: name })
                });

                const textResponse = await response.text();
                return JSON.parse(textResponse);
            }

            try {
                let result;
                // å„ªå…ˆå˜—è©¦ Scale 3 (300 DPI)
                try {
                    result = await tryUpload(3);
                } catch (e) {
                    console.warn("High res failed, retrying with lower res...", e);
                    // å¤±æ•—å‰‡é™ç´šç‚º Scale 1.5
                    result = await tryUpload(1.5);
                }

                if (result.status === "success") {
                    if (liff.isInClient()) {
                        // å˜—è©¦ Flex Message
                        try {
                            const flexMessage = {
                                "type": "flex",
                                "altText": "âœ… è‡ªåŠ©å…¥ä½ç™»è¨˜å®Œæˆ",
                                "contents": {
                                    "type": "bubble",
                                    "size": "mega",
                                    "header": {
                                        "type": "box",
                                        "layout": "vertical",
                                        "backgroundColor": "#2C3E50",
                                        "paddingAll": "xl",
                                        "contents": [
                                            { "type": "text", "text": "âœ… ç™»è¨˜å®Œæˆ", "color": "#BFA15F", "weight": "bold", "size": "lg", "align": "center" },
                                            { "type": "text", "text": "CHECK-IN COMPLETED", "color": "#95A5A6", "size": "xxs", "align": "center", "margin": "xs", "letterSpacing": "1px" }
                                        ]
                                    },
                                    "body": {
                                        "type": "box",
                                        "layout": "vertical",
                                        "paddingAll": "xl",
                                        "contents": [
                                            { "type": "text", "text": `æ­¡è¿æ‚¨ï¼Œ${name}`, "weight": "bold", "size": "lg", "color": "#1A202C" },
                                            { "type": "text", "text": "è­‰ä»¶èˆ‡è³‡æ–™å·²åŠ å¯†ä¸Šå‚³æ­¸æª”ã€‚", "size": "sm", "color": "#7F8C8D", "margin": "sm" },
                                            { "type": "separator", "margin": "xl" },
                                            {
                                                "type": "box", "layout": "vertical", "margin": "xl", "spacing": "sm",
                                                "contents": [
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ  é¤¨åˆ¥", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": house, "wrap": true, "color": "#2C3E50", "size": "sm", "flex": 5, "weight": "bold" }] },
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“… æ—¥æœŸ", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": date, "wrap": true, "color": "#2C3E50", "size": "sm", "flex": 5 }] },
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ’° åŒ¯æ¬¾", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": `${bankName} (${bankCode})`, "color": "#C5A065", "size": "sm", "flex": 5, "weight": "bold" }] }
                                                ]
                                            },
                                            { "type": "separator", "margin": "xl" },
                                            { "type": "text", "text": "ğŸ”’ æ‚¨çš„è³‡æ–™åƒ…ä¾›æ—…å®¿ç™»è¨˜ä½¿ç”¨", "size": "xxs", "color": "#BFA15F", "margin": "md", "wrap": true, "align": "center" }
                                        ]
                                    }
                                }
                            };
                            await liff.sendMessages([flexMessage]);
                        } catch (msgErr) {
                            const textMsg = `âœ… è‡ªåŠ©å…¥ä½ç™»è¨˜å®Œæˆï¼\n\nğŸ“„ æ—…å®¢ï¼š${name}\nğŸ“… æ—¥æœŸï¼š${date}\nğŸ’° åŒ¯æ¬¾ï¼š${bankName} (${bankCode})\n\nè³‡æ–™å·²åŠ å¯†æ­¸æª”ï¼Œè«‹ç­‰å¾…ç®¡å®¶ç™¼é€å…¥ä½å¯†ç¢¼ã€‚`;
                            await liff.sendMessages([{ type: "text", text: textMsg }]);
                        }

                        await Swal.fire({ icon: 'success', title: 'ç™»è¨˜æˆåŠŸ', text: 'è«‹è¿”å› LINE æŸ¥çœ‹å…¥ä½è³‡è¨Š', confirmButtonColor: '#2C3E50', timer: 3000, timerProgressBar: true });
                        liff.closeWindow();
                    } else {
                        Swal.fire({ icon: 'success', title: 'ç™»è¨˜æˆåŠŸï¼', text: 'æª”æ¡ˆå·²ä¸Šå‚³è‡³é›²ç«¯ã€‚', confirmButtonColor: '#2C3E50' });
                    }
                } else { throw new Error(result.msg || "ä¸Šå‚³å¤±æ•—"); }

            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'ä¸Šå‚³å¤±æ•—', text: err.message, confirmButtonColor: '#d33' });
            } finally {
                btn.disabled = false;
                btnText.innerHTML = "ç¢ºèªè³‡æ–™ä¸¦ä¸Šå‚³";
            }
        }

        function alertAndFocus(msg, id) {
            Swal.fire({ icon: 'warning', title: 'è«‹æª¢æŸ¥è³‡æ–™', text: msg, confirmButtonColor: '#BFA15F' }).then(() => {
                const el = document.getElementById(id);
                if(el) { el.scrollIntoView({behavior: "smooth", block: "center"}); el.classList.add('highlight-error'); setTimeout(() => el.classList.remove('highlight-error'), 1500); }
            });
        }
    </script>
</body>
</html>